app/features/calories.py:58:    is_root_media_btn,
app/features/calories.py:353:            is_root_media_btn,
app/keyboards.py:144:                "menu_media_root",
app/keyboards.py:292:def get_media_menu_kb(lang: str) -> ReplyKeyboardMarkup:
app/keyboards.py:327:def get_premium_menu_kb(lang: str, is_premium: bool = False) -> ReplyKeyboardMarkup:
app/keyboards.py:627:def is_root_media_btn(text: str) -> bool:
app/keyboards.py:802:def is_media_btn(text: str) -> bool:
app/keyboards.py:803:    """Legacy-Ð°Ð»Ð¸Ð°Ñ: ÐµÑÐ»Ð¸ Ð³Ð´Ðµ-Ñ‚Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»ÑÑ is_media_btn."""
app/keyboards.py:804:    return is_root_media_btn(text)
app/keyboards.py:831:    "get_media_menu_kb",
app/keyboards.py:832:    "get_premium_menu_kb",
app/keyboards.py:841:    "is_root_media_btn",
app/keyboards.py:856:    "is_media_btn",
app/keyboards.py.bak2:139:                "menu_media_root",
app/keyboards.py.bak2:286:def get_media_menu_kb(lang: str) -> ReplyKeyboardMarkup:
app/keyboards.py.bak2:322:def get_premium_menu_kb(lang: str, is_premium: bool = False) -> ReplyKeyboardMarkup:
app/keyboards.py.bak2:600:def is_root_media_btn(text: str) -> bool:
app/keyboards.py.bak2:770:def is_media_btn(text: str) -> bool:
app/keyboards.py.bak2:771:    """Legacy-Ð°Ð»Ð¸Ð°Ñ: ÐµÑÐ»Ð¸ Ð³Ð´Ðµ-Ñ‚Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»ÑÑ is_media_btn."""
app/keyboards.py.bak2:772:    return is_root_media_btn(text)
app/keyboards.py.bak2:799:    "get_media_menu_kb",
app/keyboards.py.bak2:800:    "get_premium_menu_kb",
app/keyboards.py.bak2:809:    "is_root_media_btn",
app/keyboards.py.bak2:823:    "is_media_btn",
app/handlers/premium.py:23:- Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ callback_data="open_premium" (Ð½ÑƒÐ¶Ð½Ð¾ Ð´Ð»Ñ features_v2)
app/handlers/premium.py:68:CB_OPEN_PREMIUM = "open_premium"
app/handlers/premium.py:625:async def open_premium_cb(
app/services/media/pipeline_tmdb.py:3:from app.services.media.query import _clean_tmdb_query, _normalize_tmdb_query
app/services/media/pipeline_tmdb.py:7:from app.services.media.safety import _scrub_media_items
app/services/media/pipeline_tmdb.py:9:from app.services.media_search import tmdb_search_multi
app/services/media/pipeline_tmdb.py:46:async def _tmdb_best_effort(query: str, *, limit: int = 5) -> list[dict]:
app/services/media/pipeline_tmdb.py:54:    q = _normalize_tmdb_query(_clean_tmdb_query(query))
app/services/media/pipeline_tmdb.py:62:            items = await tmdb_search_multi(q, lang=lang, limit=limit)
app/services/media/pipeline_tmdb.py:78:    items = _scrub_media_items(items)
app/services/media/safety.py:48:def _scrub_media_item(it: dict) -> dict:
app/services/media/safety.py:67:def _scrub_media_items(items: list[dict]) -> list[dict]:
app/services/media/safety.py:74:        out.append(_scrub_media_item(it) if isinstance(it, dict) else it)
app/handlers/assistant.py:21:    get_premium_menu_kb,
app/handlers/assistant.py:26:    is_root_media_btn, is_root_premium_btn, is_root_settings_btn, is_root_proactive_btn,
app/handlers/assistant.py:84:_MEDIA_KNOBS_LINE = "\nÐšÐ½Ð¾Ð¿ÐºÐ¸: âœ… Ð­Ñ‚Ð¾ Ð¾Ð½Ð¾ / ðŸ” Ð”Ñ€ÑƒÐ³Ð¸Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ / ðŸ§© Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ"
app/handlers/assistant.py:86:def _extract_poster_url(text: str) -> tuple[Optional[str], str]:
app/handlers/assistant.py:98:def _media_inline_kb():
app/handlers/assistant.py:100:    kb.button(text="âœ… Ð­Ñ‚Ð¾ Ð¾Ð½Ð¾", callback_data="media:ok")
app/handlers/assistant.py:101:    kb.button(text="ðŸ” Ð”Ñ€ÑƒÐ³Ð¸Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹", callback_data="media:alts")
app/handlers/assistant.py:102:    kb.button(text="ðŸ§© Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ", callback_data="media:hint")
app/handlers/assistant.py:107:def _open_premium_inline_kb():
app/handlers/assistant.py:109:    kb.button(text="ðŸ’Ž ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Premium", callback_data="open_premium")
app/handlers/assistant.py:174:def _looks_like_media_text(text: str) -> bool:
app/handlers/assistant.py:202:        is_root_assistant_btn, is_root_media_btn, is_root_premium_btn, is_root_settings_btn, is_root_proactive_btn,
app/handlers/assistant.py:224:async def _ack_media_search_once(m: Message, state: FSMContext) -> None:
app/handlers/assistant.py:227:        if data.get("_media_ack_sent"):
app/handlers/assistant.py:229:        await state.update_data(_media_ack_sent=True)
app/handlers/assistant.py:239:async def _reset_media_ack(state: FSMContext) -> None:
app/handlers/assistant.py:241:        await state.update_data(_media_ack_sent=False)
app/handlers/assistant.py:285:            reply_markup=_open_premium_inline_kb(),
app/handlers/assistant.py:298:@router.callback_query(F.data == "open_premium")
app/handlers/assistant.py:299:async def open_premium_from_inline(cb: CallbackQuery, state: FSMContext, session: AsyncSession) -> None:
app/handlers/assistant.py:317:            reply_markup=get_premium_menu_kb(lang, is_premium=is_premium),
app/handlers/assistant.py:367:        await state.update_data(_media_last_query=q, _media_last_lang=lang)
app/handlers/assistant.py:375:            reply_markup=_open_premium_inline_kb(),
app/handlers/assistant.py:379:    from app.services.assistant import _assistant_plan, run_assistant_vision
app/handlers/assistant.py:395:            _media_last_photo_file_id=getattr(ph, "file_id", None),
app/handlers/assistant.py:396:            _media_waiting_photo_desc=(not bool(caption)),
app/handlers/assistant.py:405:            last_text = (data.get("_media_last_query") or "").strip()
app/handlers/assistant.py:408:                await state.update_data(_media_waiting_photo_desc=False)
app/handlers/assistant.py:417:    await _ack_media_search_once(m, state)
app/handlers/assistant.py:420:        reply = await run_assistant_vision(user, img_bytes, caption, lang, session=session)
app/handlers/assistant.py:422:        await _reset_media_ack(state)
app/handlers/assistant.py:429:    if isinstance(reply, str) and "ÐšÐ½Ð¾Ð¿ÐºÐ¸:" in reply:
app/handlers/assistant.py:430:        clean = reply.replace(_MEDIA_KNOBS_LINE, "")
app/handlers/assistant.py:431:        poster_url, clean2 = _extract_poster_url(clean)
app/handlers/assistant.py:433:            await m.answer_photo(poster_url, caption=clean2, reply_markup=_media_inline_kb(), parse_mode=None)
app/handlers/assistant.py:435:            await m.answer(clean, reply_markup=_media_inline_kb(), parse_mode=None)
app/handlers/assistant.py:458:            reply_markup=_open_premium_inline_kb(),
app/handlers/assistant.py:472:    if data.get("_media_waiting_hint"):
app/handlers/assistant.py:473:        last_q = (data.get("_media_last_query") or "").strip()
app/handlers/assistant.py:477:            await state.update_data(_media_waiting_hint=False)
app/handlers/assistant.py:483:        await state.update_data(_media_last_query=text, _media_last_lang=lang)
app/handlers/assistant.py:487:    is_media_like = _looks_like_media_text(text)
app/handlers/assistant.py:490:        mode = getattr(user, "assistant_mode", None)
app/handlers/assistant.py:491:        until = getattr(user, "assistant_mode_until", None)
app/handlers/assistant.py:493:            is_media_like = True
app/handlers/assistant.py:496:    if is_media_like:
app/handlers/assistant.py:497:        await _ack_media_search_once(m, state)
app/handlers/assistant.py:503:        await _reset_media_ack(state)
app/handlers/assistant.py:515:        mode = getattr(user, "assistant_mode", None) if user else None
app/handlers/assistant.py:516:        until = getattr(user, "assistant_mode_until", None) if user else None
app/handlers/assistant.py:523:            await state.update_data(_media_last_query=text, _media_last_lang=lang)
app/handlers/assistant.py:526:        poster_url, clean2 = _extract_poster_url(reply)
app/handlers/assistant.py:528:            await m.answer_photo(poster_url, caption=clean2, reply_markup=_media_inline_kb(), parse_mode=None)
app/handlers/assistant.py:530:            await m.answer(reply, reply_markup=_media_inline_kb(), parse_mode=None)
app/handlers/assistant.py:532:    if isinstance(reply, str) and "ÐšÐ½Ð¾Ð¿ÐºÐ¸:" in reply:
app/handlers/assistant.py:533:        clean = reply.replace(_MEDIA_KNOBS_LINE, "")
app/handlers/assistant.py:534:        poster_url, clean2 = _extract_poster_url(clean)
app/handlers/assistant.py:536:            await m.answer_photo(poster_url, caption=clean2, reply_markup=_media_inline_kb(), parse_mode=None)
app/handlers/assistant.py:538:            await m.answer(clean, reply_markup=_media_inline_kb(), parse_mode=None)
app/handlers/assistant.py:542:@router.callback_query(F.data == "media:ok")
app/handlers/assistant.py:553:@router.callback_query(F.data == "media:alts")
app/handlers/assistant.py:561:    last_q = (data.get("_media_last_query") or "").strip()
app/handlers/assistant.py:562:    lang = (data.get("_media_last_lang") or "ru").strip()
app/handlers/assistant.py:590:    if isinstance(reply, str) and "ÐšÐ½Ð¾Ð¿ÐºÐ¸:" in reply:
app/handlers/assistant.py:591:        clean = reply.replace(_MEDIA_KNOBS_LINE, "")
app/handlers/assistant.py:592:        poster_url, clean2 = _extract_poster_url(clean)
app/handlers/assistant.py:594:            await state.update_data(_media_last_query=prompt, _media_last_lang=lang)
app/handlers/assistant.py:599:            await call.message.answer_photo(poster_url, caption=clean2, reply_markup=_media_inline_kb(), parse_mode=None)
app/handlers/assistant.py:601:            await call.message.answer(clean, reply_markup=_media_inline_kb(), parse_mode=None)
app/handlers/assistant.py:608:@router.callback_query(F.data == "media:hint")
app/handlers/assistant.py:612:        await state.update_data(_media_waiting_hint=True)
app/handlers/assistant.py:636:            mode = getattr(user, 'assistant_mode', None) if user else None
app/handlers/assistant.py:637:            until = getattr(user, 'assistant_mode_until', None) if user else None
app/handlers/premium_bridge_v2.py:12:@router.callback_query(F.data == "open_premium")
app/handlers/premium_bridge_v2.py:13:async def open_premium_cb(
app/handlers/premium_bridge_v2.py:20:    Ð»ÑŽÐ±Ð°Ñ ÐºÐ½Ð¾Ð¿ÐºÐ° Ñ callback_data="open_premium"
app/services/media/vision_parse.py:4:    _tmdb_sanitize_query, _normalize_tmdb_query, _good_tmdb_cand, GENERIC_TITLE_WORDS
app/services/media/vision_parse.py:50:def _extract_media_json_from_model_text(text: str) -> Optional[dict]:
app/services/media/vision_parse.py:110:def _build_tmdb_queries_from_media_json(mj: Optional[dict]) -> list[str]:
app/services/media/vision_parse.py:125:        q = _tmdb_sanitize_query(_normalize_tmdb_query(q))
app/services/media/vision_parse.py:126:        if q and q not in out and _good_tmdb_cand(q):
app/services/media/vision_parse.py:141:            s2 = _tmdb_sanitize_query(_normalize_tmdb_query(s))
app/services/media/formatting.py:18:def build_media_context(items: list[dict]) -> str:
app/services/media/formatting.py:32:def _format_media_pick(item: dict) -> str:
app/services/media/formatting.py:46:    tmdb_id = item.get("id")
app/services/media/formatting.py:48:    if tmdb_id:
app/services/media/formatting.py:49:        url = f"https://www.themoviedb.org/{media_type}/{tmdb_id}"
app/services/media/formatting.py:76:def _tmdb_score_item(query: str, it: dict, *, year_hint: str | None = None, lang_hint: str | None = None) -> tuple[float, str]:
app/services/media/formatting.py:128:def _format_media_ranked(query: str, items: list[dict], *, year_hint: str | None = None, lang: str = "ru", source: str = "tmdb") -> str:
app/services/media/formatting.py:146:            sc, why = _tmdb_score_item(query, it, year_hint=year_hint, lang_hint=("ru" if lang == "ru" else None))
app/services/media/formatting.py:205:    # items come from tmdb_search_multi(): title/year/media_type/overview/vote_average
app/services/media/session.py:3:from app.services.media.query import _normalize_tmdb_query, _tmdb_sanitize_query
app/services/media/session.py:13:def _media_ctx_should_stick(intent: Intent) -> bool:
app/services/media/session.py:16:async def _clear_sticky_media_if_any(state) -> None:
app/services/media/session.py:40:def _media_uid(user: Any) -> str:
app/services/media/session.py:47:def _media_get(uid: str) -> Optional[dict]:
app/services/media/session.py:58:def _media_set(uid: str, query: str, items: list[dict]) -> None:
app/services/media/session.py:61:    q = _normalize_tmdb_query(query)
app/services/media/session.py:63:        "query": _tmdb_sanitize_query(q),
app/handlers/menus.py:17:    get_media_menu_kb,
app/handlers/menus.py:19:    get_premium_menu_kb,
app/handlers/menus.py:21:    is_root_media_btn,
app/handlers/menus.py:31:from app.handlers.assistant import _media_inline_kb
app/handlers/menus.py:101:@router.message(F.text.func(is_root_media_btn))
app/handlers/menus.py:102:async def open_media_menu(m: Message, session: AsyncSession, state: FSMContext) -> None:
app/handlers/menus.py:111:    await _log(session, user, tg_lang, "open_media_menu", "menu")
app/handlers/menus.py:112:    await m.answer("ðŸ§˜ ÐœÐµÐ´Ð¸Ð°", reply_markup=get_media_menu_kb(lang))
app/handlers/menus.py:146:async def open_premium_menu(m: Message, session: AsyncSession, state: FSMContext) -> None:
app/handlers/menus.py:160:    await m.answer("ðŸ’Ž ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼", reply_markup=get_premium_menu_kb(lang, is_premium=is_premium))
app/handlers/menus.py:223:    # Ð•ÑÐ»Ð¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½ assistant_mode == 'media', Ñ‚Ð¾ Ð»ÑŽÐ±Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚ ÑƒÑ…Ð¾Ð´Ð¸Ñ‚ Ð² run_assistant.
app/handlers/menus.py:226:    if not user or getattr(user, "assistant_mode", None) != "media":
app/handlers/menus.py:234:    until = getattr(user, "assistant_mode_until", None)
app/handlers/menus.py:245:        clean = reply.replace("\nÐšÐ½Ð¾Ð¿ÐºÐ¸: âœ… Ð­Ñ‚Ð¾ Ð¾Ð½Ð¾ / ðŸ” Ð”Ñ€ÑƒÐ³Ð¸Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ / ðŸ§© Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ", "")
app/handlers/menus.py:246:        await message.answer(clean, reply_markup=_media_inline_kb(), parse_mode=None)
app/services/media_web_pipeline.py:173:# --- Lens post-processing (cleanup titles -> TMDB-friendly short candidates) ---
app/services/media_web_pipeline.py:279:    # If we have "9-1-1" â€” force it to be first (fast TMDB hit)
app/services/media_web_pipeline.py:351:async def image_to_tmdb_candidates(
app/services/media_web_pipeline.py:358:    ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð´Ð°Ð»ÑŒÑˆÐµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð³Ð¾Ð½ÑÑ‚ÑŒ Ð² TMDB search/multi.
app/services/media_web_pipeline.py:370:    # post-process: raw lens titles -> TMDB-friendly candidates
app/services/media_web_pipeline.py:375:async def image_bytes_to_tmdb_candidates(
app/services/media_web_pipeline.py:383:    Bytes (Telegram photo/file bytes) -> upload to Spaces -> public URL -> SerpAPI Lens -> TMDB-friendly candidates.
app/services/media_web_pipeline.py:404:    cands, tag = await image_to_tmdb_candidates(public_url, use_serpapi_lens=use_serpapi_lens, hl=hl)
app/services/media_web_pipeline.py:407:async def web_to_tmdb_candidates(query: str, use_serpapi: bool = False) -> Tuple[List[str], str]:
app/services/media_web_pipeline.py:421:    # ðŸŽ¯ Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ S02E10 â€” Ð´Ð°Ñ‘Ð¼ TMDB Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð¿Ð¾Ð½ÑÑ‚Ð½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹
app/services/media/query.py:16:def _clean_tmdb_query(q: str) -> str:
app/services/media/query.py:33:def _parse_media_hints(text: str) -> dict:
app/services/media/query.py:58:def _clean_query_for_tmdb(q: str) -> str:
app/services/media/query.py:75:def _looks_like_freeform_media_query(q: str) -> bool:
app/services/media/query.py:107:def _tmdb_sanitize_query(q: str) -> str:
app/services/media/query.py:136:    # Hard length cap (TMDB works best with short queries)
app/services/media/query.py:148:def _good_tmdb_cand(q: str) -> bool:
app/services/media/query.py:192:def _is_generic_media_caption(text: str) -> bool:
app/services/media/query.py:220:def _extract_media_kind_marker(text: str) -> str:
app/services/media/query.py:247:def _clean_media_search_query(text: str) -> str:
app/services/media/query.py:249:    Aggressive cleanup of user description before sending to TMDB.
app/services/media/query.py:274:def _normalize_tmdb_query(q: str, *, max_len: int = 140) -> str:
app/services/media/query.py:408:def _media_clean_user_query(q: str) -> str:
app/services/media/query.py:431:def _is_bad_media_query(q: str) -> bool:
app/services/features.py:89:CB_OPEN_PREMIUM = "open_premium"
app/services/features_v2.py:84:CB_OPEN_PREMIUM = "open_premium"
app/services/assistant.py:64:    _dbg_media(logger, 'enter_safe', is_media=locals().get('is_media'), sticky_media_db=locals().get('sticky_media_db'), has_st=locals().get('has_st'), uid=str(locals().get('uid')))
app/services/assistant.py:85:    _format_media_pick,
app/services/assistant.py:86:    _format_media_ranked,
app/services/assistant.py:87:    build_media_context,
app/services/assistant.py:98:from app.services.media.pipeline_tmdb import _tmdb_best_effort
app/services/assistant.py:100:    _clean_media_search_query,
app/services/assistant.py:101:    _clean_tmdb_query,
app/services/assistant.py:102:    _extract_media_kind_marker,
app/services/assistant.py:103:    _good_tmdb_cand,
app/services/assistant.py:105:    _is_bad_media_query,
app/services/assistant.py:106:    _is_generic_media_caption,
app/services/assistant.py:107:    _looks_like_freeform_media_query,
app/services/assistant.py:108:    _normalize_tmdb_query,
app/services/assistant.py:109:    _parse_media_hints,
app/services/assistant.py:110:    _tmdb_sanitize_query,
app/services/assistant.py:113:    _scrub_media_items,
app/services/assistant.py:119:    _media_get,
app/services/assistant.py:120:    _media_set,
app/services/assistant.py:121:    _media_uid,
app/services/assistant.py:124:    _build_tmdb_queries_from_media_json,
app/services/assistant.py:125:    _extract_media_json_from_model_text,
app/services/assistant.py:140:# Used by _is_generic_media_caption
app/services/assistant.py:187:    from app.services.media_search import tmdb_search_multi  # expected existing
app/services/assistant.py:190:    async def tmdb_search_multi(*args: Any, **kwargs: Any) -> list[dict]:
app/services/assistant.py:196:        web_to_tmdb_candidates,  # expected existing
app/services/assistant.py:200:    async def web_to_tmdb_candidates(
app/services/assistant.py:208:        image_bytes_to_tmdb_candidates,
app/services/assistant.py:212:    async def image_bytes_to_tmdb_candidates(
app/services/assistant.py:236:# --- TMDB query sanitizer: TMDB hates long "scene description" queries ---
app/services/assistant.py:267:def _media_confident(item: dict) -> bool:
app/services/assistant.py:385:def _is_media_query(text: str) -> bool:
app/services/assistant.py:610:    kind_marker = _extract_media_kind_marker(text)
app/services/assistant.py:617:    uid = _media_uid(user)
app/services/assistant.py:618:    st = _media_get(uid)  # in-memory session, survives even if session=None
app/services/assistant.py:620:    sticky_media_db = False
app/services/assistant.py:622:        mode = getattr(user, "assistant_mode", None)
app/services/assistant.py:623:        until = getattr(user, "assistant_mode_until", None)
app/services/assistant.py:625:            sticky_media_db = True
app/services/assistant.py:641:                mode = getattr(user, 'assistant_mode', None)
app/services/assistant.py:643:                    setattr(user, 'assistant_mode', None)
app/services/assistant.py:644:                    setattr(user, 'assistant_mode_until', now - timedelta(seconds=1))
app/services/assistant.py:650:    is_media = bool(has_media) or bool(is_intent_media) or (sticky_media_db and bool(is_intent_media)) or (bool(st) and bool(is_intent_media))
app/services/assistant.py:657:            sticky_media_db=sticky_media_db,
app/services/assistant.py:666:                raw_norm = _tmdb_sanitize_query(_normalize_tmdb_query(raw_text.strip()))
app/services/assistant.py:667:                prev_norm = _tmdb_sanitize_query(_normalize_tmdb_query((st.get('query') or '').strip()))
app/services/assistant.py:670:                    return _format_media_ranked(prev_norm, opts, year_hint=_parse_media_hints(prev_norm).get('year'), lang=lang, source='cache')
app/services/assistant.py:681:                    _format_media_pick(picked)
app/services/assistant.py:690:            return build_media_context(opts) + "\n\nðŸ‘‰ ÐÐ°Ð¶Ð¼Ð¸ ÐºÐ½Ð¾Ð¿ÐºÑƒ: âœ… Ð­Ñ‚Ð¾ Ð¾Ð½Ð¾ / ðŸ” Ð”Ñ€ÑƒÐ³Ð¸Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ / ðŸ§© Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ.\nÐ•ÑÐ»Ð¸ ÐºÐ½Ð¾Ð¿Ð¾Ðº Ð½ÐµÑ‚ â€” Ð¾Ñ‚Ð²ÐµÑ‚ÑŒ Ñ†Ð¸Ñ„Ñ€Ð¾Ð¹."
app/services/assistant.py:706:        raw = _normalize_tmdb_query(raw)
app/services/assistant.py:715:                query = _tmdb_sanitize_query(_normalize_tmdb_query(prev_q))
app/services/assistant.py:718:                query = _tmdb_sanitize_query(_normalize_tmdb_query(raw))
app/services/assistant.py:720:                query = _tmdb_sanitize_query(_normalize_tmdb_query(f"{prev_q} {raw}"))
app/services/assistant.py:722:            query = _tmdb_sanitize_query(_clean_media_search_query(raw))
app/services/assistant.py:729:                setattr(user, "assistant_mode", "media")
app/services/assistant.py:730:                setattr(user, "assistant_mode_until", now + timedelta(minutes=10))
app/services/assistant.py:736:        cleaned = _normalize_tmdb_query(query)
app/services/assistant.py:737:        query = _tmdb_sanitize_query(_normalize_tmdb_query(cleaned or query))
app/services/assistant.py:743:            items = await _tmdb_best_effort(query, limit=5)
app/services/assistant.py:744:            items = _scrub_media_items(items)
app/services/assistant.py:746:                "media.tmdb.primary",
app/services/assistant.py:755:            hints = _parse_media_hints(query)
app/services/assistant.py:757:                items = await _tmdb_best_effort(hints["keywords"], limit=5)
app/services/assistant.py:761:                    tmdb_discover_with_people,
app/services/assistant.py:762:                    tmdb_search_person,
app/services/assistant.py:766:                    pid = await tmdb_search_person(actor)
app/services/assistant.py:768:                        items = await tmdb_discover_with_people(
app/services/assistant.py:782:            if items and raw and _looks_like_freeform_media_query(raw):
app/services/assistant.py:792:            query = _normalize_tmdb_query(query)
app/services/assistant.py:796:                    if _is_bad_media_query(c):
app/services/assistant.py:798:                    c = _tmdb_sanitize_query(_normalize_tmdb_query(c))
app/services/assistant.py:799:                    if not _good_tmdb_cand(c):
app/services/assistant.py:801:                    out = await _tmdb_best_effort(c, limit=5)
app/services/assistant.py:809:                if is_intent_media and (st or sticky_media_db) and text:
app/services/assistant.py:815:                cands, tag = await web_to_tmdb_candidates(query, use_serpapi=False)
app/services/assistant.py:832:                    cands, tag = await web_to_tmdb_candidates(query, use_serpapi=True)
app/services/assistant.py:846:            setattr(user, "assistant_mode", "media")
app/services/assistant.py:847:            setattr(user, "assistant_mode_until", now + timedelta(minutes=10))
app/services/assistant.py:854:                _media_set(uid, query, [])
app/services/assistant.py:857:        items = _scrub_media_items(items)
app/services/assistant.py:859:            _media_set(uid, query, items)
app/services/assistant.py:860:        return _format_media_ranked(query, items, year_hint=_parse_media_hints(query).get('year'), lang=lang, source='tmdb')
app/services/assistant.py:919:async def run_assistant_vision(
app/services/assistant.py:1093:        lens_cands, lens_tag = await image_bytes_to_tmdb_candidates(
app/services/assistant.py:1126:                cand0 = _normalize_tmdb_query(_clean_tmdb_query(cand0))
app/services/assistant.py:1129:                if _is_bad_media_query(cand0):
app/services/assistant.py:1132:                cand0 = _tmdb_sanitize_query(_normalize_tmdb_query(cand0))
app/services/assistant.py:1133:                if not _good_tmdb_cand(cand0):
app/services/assistant.py:1135:                items = await _tmdb_best_effort(cand0, limit=5)
app/services/assistant.py:1146:                setattr(user, "assistant_mode", "media")
app/services/assistant.py:1147:                setattr(user, "assistant_mode_until", now + timedelta(minutes=10))
app/services/assistant.py:1151:            uid = _media_uid(user)
app/services/assistant.py:1153:                _media_set(uid, used_cand, items)
app/services/assistant.py:1155:                reply = _format_media_ranked(used_cand, items, year_hint=_parse_media_hints(used_cand).get('year'), lang=lang, source='tmdb')
app/services/assistant.py:1171:        is_generic_caption=_is_generic_media_caption(caption_str),
app/services/assistant.py:1174:    search_q = _normalize_tmdb_query(_extract_search_query_from_text(out_text))
app/services/assistant.py:1175:    title_from_text = _normalize_tmdb_query(
app/services/assistant.py:1184:        mj = _extract_media_json_from_model_text(out_text)
app/services/assistant.py:1185:        json_queries = _build_tmdb_queries_from_media_json(mj)
app/services/assistant.py:1200:        c = _tmdb_sanitize_query(_normalize_tmdb_query(c))
app/services/assistant.py:1201:        if c and _good_tmdb_cand(c) and c not in cand_list:
app/services/assistant.py:1205:        c = _tmdb_sanitize_query(_normalize_tmdb_query(c))
app/services/assistant.py:1206:        if c and _good_tmdb_cand(c) and c not in cand_list:
app/services/assistant.py:1210:    if caption_str and (not _is_generic_media_caption(caption_str)):
app/services/assistant.py:1211:        c = _tmdb_sanitize_query(_normalize_tmdb_query(caption_str))
app/services/assistant.py:1212:        if c and _good_tmdb_cand(c) and c not in cand_list:
app/services/assistant.py:1217:        c = _tmdb_sanitize_query(_normalize_tmdb_query(c))
app/services/assistant.py:1218:        if c and _good_tmdb_cand(c) and c not in cand_list:
app/services/assistant.py:1231:        if not _good_tmdb_cand(q):
app/services/assistant.py:1233:        _d("vision.tmdb.try", q=q)  # DBG_VISION_TMBD_TRY_V2
app/services/assistant.py:1236:            q = _normalize_tmdb_query(q)
app/services/assistant.py:1237:            items = await _tmdb_best_effort(q, limit=5)
app/services/assistant.py:1246:                    "vision.tmdb.hit",
app/services/assistant.py:1261:            cands, tag = await web_to_tmdb_candidates(q0, use_serpapi=use_serp)
app/services/assistant.py:1264:                if _is_bad_media_query(c):
app/services/assistant.py:1266:                c = _tmdb_sanitize_query(_normalize_tmdb_query(c))
app/services/assistant.py:1267:                c = _normalize_tmdb_query(c)
app/services/assistant.py:1268:                if not _good_tmdb_cand(c):
app/services/assistant.py:1270:                items = await _tmdb_best_effort(c, limit=5)
app/services/assistant.py:1281:            setattr(user, "assistant_mode", "media")
app/services/assistant.py:1282:            setattr(user, "assistant_mode_until", now + timedelta(minutes=10))
app/services/assistant.py:1286:        uid = _media_uid(user)
app/services/assistant.py:1288:            _media_set(uid, used_query or (cand_list[0] if cand_list else ""), items)
app/services/assistant.py:1290:        reply = _format_media_ranked(
app/services/assistant.py:1293:            year_hint=_parse_media_hints(used_query or (cand_list[0] if cand_list else "")).get("year"),
app/services/assistant.py:1295:            source="tmdb",
app/services/media_search.py:8:TMDB_API = "https://api.themoviedb.org/3"
app/services/media_search.py:9:TMDB_IMG = "https://image.tmdb.org/t/p/w342"
app/services/media_search.py:15:def _tmdb_auth_headers_and_params() -> Tuple[Dict[str, str], Dict[str, str]]:
app/services/media_search.py:18:    - v4 Read Access Token: Authorization: Bearer <token>  (TMDB_API_KEY)
app/services/media_search.py:19:    - v3 API key: ?api_key=<key>                          (TMDB_API_KEY_V3)
app/services/media_search.py:21:    token = _env("TMDB_API_KEY")
app/services/media_search.py:22:    api_key_v3 = _env("TMDB_API_KEY_V3")
app/services/media_search.py:34:async def tmdb_search_multi(query: str, *, lang: str = "ru-RU", limit: int = 5) -> List[Dict[str, Any]]:
app/services/media_search.py:39:    headers, base_params = _tmdb_auth_headers_and_params()
app/services/media_search.py:43:    url = f"{TMDB_API}/search/multi"
app/services/media_search.py:88:def build_media_context(items: List[Dict[str, Any]]) -> str:
app/services/media_search.py:103:        poster_url = f"{TMDB_IMG}{poster_path}" if poster_path else ""
app/services/media_search.py:112:async def tmdb_search_person(name: str):
app/services/media_search.py:113:    headers, base_params = _tmdb_auth_headers_and_params()
app/services/media_search.py:114:    url = f"{TMDB_API}/search/person"
app/services/media_search.py:126:async def tmdb_discover_with_people(person_id: int, *, year: str | None, kind: str | None):
app/services/media_search.py:127:    headers, base_params = _tmdb_auth_headers_and_params()
app/services/media_search.py:129:    url = f"{TMDB_API}/discover/{media_type}"
