<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ValFlow Music</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { background:#0f0f12; color:#fff; font-family:system-ui,-apple-system,sans-serif; padding:15px; }
    h2 { margin: 0 0 10px; }
    .muted { opacity:.7; font-size: 13px; margin-bottom: 12px; }
    .track { padding:12px; border:1px solid #222; border-radius:12px; margin:10px 0; background:#121218; }
    .title { font-weight:700; margin-bottom: 6px; }
    audio { width: 100%; margin-top: 6px; }
  </style>
</head>
<body>

<h2>üéµ –ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç</h2>
<div class="muted" id="status">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>
<div id="tracks"></div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

function uid() {
  return tg?.initDataUnsafe?.user?.id || null;
}

async function loadTracks() {
  const userId = uid();
  const status = document.getElementById("status");
  const container = document.getElementById("tracks");
  container.innerHTML = "";

  if (!userId) {
    status.textContent = "–ù–µ—Ç user.id. –û—Ç–∫—Ä–æ–π –ø–ª–µ–µ—Ä –∏–∑ –∫–Ω–æ–ø–∫–∏ –≤ –±–æ—Ç–µ.";
    return;
  }

  const res = await fetch(`/api/music/my?uid=${encodeURIComponent(userId)}`);
  if (!res.ok) {
    status.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç.";
    return;
  }

  const data = await res.json();
  if (!Array.isArray(data) || data.length === 0) {
    status.textContent = "–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç. –î–æ–±–∞–≤—å —Ç—Ä–µ–∫ –≤ –±–æ—Ç–µ.";
    return;
  }

  status.textContent = `–¢—Ä–µ–∫–æ–≤: ${data.length}`;

  data.forEach(t => {
    const div = document.createElement("div");
    div.className = "track";

    const title = (t.title || "Track").replaceAll("<","&lt;").replaceAll(">","&gt;");
    const src = (t.stream_url || "").trim();

    div.innerHTML = `
      <div class="title">${title}</div>
      <audio controls preload="none" src="${src}"></audio>
    `;
    container.appendChild(div);
  });
}

loadTracks();
</script>
</body>
</html>
