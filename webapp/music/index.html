<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ValFlow Music</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f0f12;
      --card:#151520;
      --stroke:#26263a;
      --muted:rgba(255,255,255,.72);
      --text:#fff;
      --btn:#2b78ff;
      --btn2:#2a2a38;
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,sans-serif;
      padding:18px;
    }
    .top{display:flex; flex-direction:column; gap:6px; margin-bottom:14px;}
    .h1{font-size:22px; font-weight:800;}
    .sub{font-size:15px; color:var(--muted);}

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px;
      margin:10px 0;
    }
    .row{background:var(--card); border:1px solid var(--stroke); border-radius:18px; padding:14px; margin:10px 0;}
    .title{font-size:18px; font-weight:800; line-height:1.2;}
    .meta{font-size:14px; color:var(--muted); margin-top:8px;}
    .player{width:100%; margin-top:12px;}
    .btns{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;}
    button{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-size:16px;
      font-weight:700;
      color:#fff;
      background:var(--btn2);
    }
    .primary{background:var(--btn);}
    .error{color:#ffd0d0;}
    .empty{background:var(--card); border:1px dashed var(--stroke); border-radius:18px; padding:16px; font-size:16px; color:var(--muted);}
  </style>
</head>

<body>
  <div class="top">
    <div class="h1">üéµ –ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç</div>
    <div class="sub" id="subtitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </div>

  <div class="card error" id="error" style="display:none"></div>
  <div id="list"></div>

<script>
(function(){
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  try { tg && tg.ready && tg.ready(); } catch(e){}

  const subtitle = document.getElementById('subtitle');
  const errorBox = document.getElementById('error');
  const list = document.getElementById('list');

  function showError(msg){
    errorBox.style.display = 'block';
    errorBox.textContent = msg;
    subtitle.textContent = '–û—à–∏–±–∫–∞';
  }

  function sendPlayToBot(trackId){
    if (!tg) return;
    const payload = { action: "play", id: trackId };
    try { tg.sendData(JSON.stringify(payload)); } catch(e){}
  }

  function render(items){
    list.innerHTML = '';
    if (!items || !items.length){
      subtitle.textContent = '–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç. –î–æ–±–∞–≤—å —Ç—Ä–µ–∫ –≤ –±–æ—Ç–µ.';
      const empty = document.createElement('div');
      empty.className = 'empty';
      empty.textContent = '–ü–æ–∫–∞ –ø—É—Å—Ç–æ.';
      list.appendChild(empty);
      return;
    }
    subtitle.textContent = `–¢—Ä–µ–∫–æ–≤: ${items.length}`;

    for (const it of items){
      const row = document.createElement('div');
      row.className = 'row';

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = it.title || 'Track';

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = it.is_url ? '–ò—Å—Ç–æ—á–Ω–∏–∫: —Å—Å—ã–ª–∫–∞ (full)' : '–ò—Å—Ç–æ—á–Ω–∏–∫: Telegram';

      row.appendChild(title);
      row.appendChild(meta);

      if (it.is_url && it.file_id){
        const audio = document.createElement('audio');
        audio.className = 'player';
        audio.controls = true;
        audio.src = it.file_id;
        row.appendChild(audio);
      } else {
        const btns = document.createElement('div');
        btns.className = 'btns';

        const playBtn = document.createElement('button');
        playBtn.className = 'primary';
        playBtn.textContent = '‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å –≤ Telegram';
        playBtn.onclick = () => sendPlayToBot(it.id);

        btns.appendChild(playBtn);
        row.appendChild(btns);
      }

      list.appendChild(row);
    }
  }

  async function load(){
    subtitle.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';

    let tgId = null;
    try {
      tgId = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
    } catch(e){ tgId = null; }

    if (!tgId){
      showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram. –û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –±–æ—Ç–∞.');
      return;
    }

    const base = window.location.origin;
    const url = base + `/webapp/music/api/my?tg_id=${encodeURIComponent(tgId)}`;

    try{
      const r = await fetch(url, { credentials: 'include' });
      const js = await r.json();
      if (!js || !js.ok) throw new Error('bad response');
      render(js.items || []);
    } catch(e){
      showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç. –ü—Ä–æ–≤–µ—Ä—å –¥–µ–ø–ª–æ–π/API.');
    }
  }

  load();
})();
</script>
</body>
</html>
