<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Diary Music</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --card2:#0f1622;
      --text:#e9eef6;
      --muted:#9aa7b8;
      --stroke:#1f2a3a;
      --chip:#162033;
      --chipOn:#24324a;
      --accent:#3aa0ff;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background: radial-gradient(900px 500px at 20% -10%, rgba(58,160,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 120% 0%, rgba(120,80,255,.22), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px 16px 90px;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px 4px 10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700; letter-spacing:.2px;
    }
    .logo{
      width:34px;height:34px;border-radius:10px;
      background: linear-gradient(135deg, rgba(58,160,255,.95), rgba(120,80,255,.9));
      box-shadow: var(--shadow);
    }
    .brand small{display:block;color:var(--muted);font-weight:600;letter-spacing:.3px}
    .actions{display:flex;align-items:center;gap:10px}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:active{transform:translateY(1px)}
    .search{
      display:flex; gap:10px;
      padding:12px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius: var(--r);
      box-shadow: var(--shadow);
    }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
      color:var(--text);
      font-size:16px;
    }
    .chips{
      display:flex;
      gap:8px;
      overflow:auto;
      padding:12px 2px 0;
      -webkit-overflow-scrolling: touch;
    }
    .chip{
      white-space:nowrap;
      border:1px solid var(--stroke);
      background: var(--chip);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      opacity:.95;
    }
    .chip.on{background:var(--chipOn); border-color: rgba(58,160,255,.35)}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.35fr 1fr;
      gap:14px;
    }
    @media (max-width:860px){
      .grid{grid-template-columns:1fr}
    }
    .panel{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel h3{
      margin:0;
      padding:14px 14px 10px;
      font-size:16px;
      letter-spacing:.2px;
    }
    .panel .sub{
      padding:0 14px 12px;
      color:var(--muted);
      font-weight:600;
      font-size:13px;
    }
    .list{
      border-top:1px solid var(--stroke);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 420px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .item{
      display:flex;
      gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,.05);
      background: rgba(17,24,36,.55);
      border-radius:14px;
      cursor:pointer;
    }
    .thumb{
      width:70px;height:70px;border-radius:12px;
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
      overflow:hidden;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{min-width:0;flex:1}
    .title{
      font-weight:800;
      font-size:14px;
      line-height:1.25;
      margin:2px 0 6px;
      overflow:hidden;

      /* standard (–≥–¥–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è) */
      line-clamp: 2;

      /* webkit fallback (Telegram iOS / Safari) */
      display:-webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;

      /* fallback –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è clamp */
      max-height: 2.5em;
      }
    .chan{
      color:var(--muted);
      font-weight:700;
      font-size:12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .tag{
      margin-left:auto;
      align-self:flex-start;
      font-size:11px;
      font-weight:800;
      color: rgba(58,160,255,.95);
      border:1px solid rgba(58,160,255,.25);
      padding:5px 8px;
      border-radius:999px;
      background: rgba(58,160,255,.08);
    }

    .player{
      padding:0;
    }
    .playerbox{
      padding:14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .now{
      min-width:0; flex:1;
    }
    .now .t{font-weight:900;margin:0 0 6px;font-size:15px;line-height:1.25}
    .now .c{color:var(--muted);font-weight:700;font-size:12px}
    .iframe{
      border-top:1px solid var(--stroke);
      background: rgba(0,0,0,.2);
      aspect-ratio: 16/9;
      width:100%;
    }
    iframe{width:100%;height:100%;border:0;display:block}

    .footerbar{
      position:fixed;
      left:0;right:0;bottom:0;
      padding:10px 12px;
      background: rgba(9,12,16,.7);
      border-top:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(12px);
    }
    .foot{
      max-width:980px;margin:0 auto;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    
    .modebar{
      display:flex; gap:8px; padding:0 14px 12px;
    }
    .modebtn{
      border:1px solid var(--stroke);
      background: var(--chip);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      opacity:.95;
      font-size:12px;
    }
    .modebtn.on{background:var(--chipOn); border-color: rgba(58,160,255,.35)}
.status{color:var(--muted);font-weight:700;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  
.iframe{pointer-events:none;}
.iframe.active{pointer-events:auto;}
  /* CLICK_FIX */
  body::before, body::after { pointer-events: none !important; }
  .wrap, .wrap * { pointer-events: auto; }
  button, input, .chip, .item, a { pointer-events: auto !important; }


/* === Premium micro-animations (GPU-friendly) === */
:root{
  --ease: cubic-bezier(.2,.8,.2,1);
  --dur: 180ms;
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  *, *::before, *::after { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
}

/* Entrance */
.wrap{ opacity:0; transform: translateY(6px); }
body.is-ready .wrap{ opacity:1; transform: translateY(0); transition: opacity 420ms var(--ease), transform 420ms var(--ease); }

/* Tabs/panels */
.ux-panel2{ opacity:0; transform: translateY(4px); transition: opacity 220ms var(--ease), transform 220ms var(--ease); }
.ux-panel2.is-active{ opacity:1; transform: translateY(0); }

/* Buttons & chips */
.btn, .chip, .ux-tab2, .ux-chip, .modebtn{
  transition: transform var(--dur) var(--ease),
              filter var(--dur) var(--ease),
              background-color var(--dur) var(--ease),
              border-color var(--dur) var(--ease);
  will-change: transform;
}
.btn:hover, .ux-tab2:hover, .ux-chip:hover, .chip:hover, .modebtn:hover { filter: brightness(1.06); }
.btn:active, .ux-tab2:active, .ux-chip:active, .chip:active, .modebtn:active { transform: translateY(1px) scale(.99); }

/* Cards */
.panel{
  transition: transform 240ms var(--ease), filter 240ms var(--ease);
  will-change: transform;
}
.panel:hover{ transform: translateY(-1px); filter: brightness(1.02); }

.item{
  transition: transform 220ms var(--ease), filter 220ms var(--ease), border-color 220ms var(--ease);
  will-change: transform;
}
.item:hover{ transform: translateY(-1px); filter: brightness(1.03); border-color: rgba(58,160,255,.22); }

/* Soft "premium aura" on logo (very subtle) */
.logo{
  position: relative;
  overflow: hidden;
}
.logo::after{
  content:"";
  position:absolute; inset:-30%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 45%),
              radial-gradient(circle at 70% 70%, rgba(255,255,255,.14), transparent 55%);
  opacity:.22;
  transform: translate3d(0,0,0);
  animation: logoGlow 3.6s var(--ease) infinite;
  pointer-events:none;
}
@keyframes logoGlow{
  0%   { opacity:.18; transform: translate3d(-2px,-2px,0) scale(1.02); }
  50%  { opacity:.28; transform: translate3d( 2px, 2px,0) scale(1.06); }
  100% { opacity:.18; transform: translate3d(-2px,-2px,0) scale(1.02); }
}

/* Play tag micro pulse (optional but subtle) */
.tag{
  transition: transform 220ms var(--ease), filter 220ms var(--ease);
}
.item:hover .tag{ transform: translateY(-1px); filter: brightness(1.05); }
/* === /Premium micro-animations === */



/* === Active track highlight (premium, lightweight) === */
.item.is-active{
  border-color: rgba(58,160,255,.32) !important;
  background: rgba(58,160,255,.08) !important;
  transform: translateY(-1px) scale(1.006);
  filter: brightness(1.03);
}
.item.is-active .tag{
  filter: brightness(1.08);
}
.item.is-active::after{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius:14px;
  pointer-events:none;
  box-shadow: 0 0 0 1px rgba(58,160,255,.18) inset;
}
/* Make .item positionable for ::after */
.item{ position: relative; }
/* === /Active track highlight === */


#chips{display:none !important;}

/* SPLIT_LISTS */
#listMy{max-height:420px;overflow:auto;-webkit-overflow-scrolling:touch;}
#listSearch{max-height:420px;overflow:auto;-webkit-overflow-scrolling:touch;}
</style>

</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
<div>
          Diary Music
          <small>–ø–æ–∏—Å–∫ —Ç—Ä–µ–∫–æ–≤, —Ä–µ–º–∏–∫—Å–æ–≤ –∏ –≤–µ—Ä—Å–∏–π</small>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnMy">–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç</button><!-- ux: hidden by tabs -->
        <button class="btn" id="btnClear">–û—á–∏—Å—Ç–∏—Ç—å</button><!-- ux: hidden by tabs -->
      </div>
    </div>

    <div class="search">
      <input id="q" placeholder="–ê—Ä—Ç–∏—Å—Ç –∏–ª–∏ —Ç—Ä–µ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Luxor / Luxor 100 –ø—Ä–∏—á–∏–Ω)" autocomplete="off" />
      <button class="btn" id="btnGo">–ù–∞–π—Ç–∏</button>
    </div>

<!-- UX: Clean Tabs -->
<style>
  .ux-tabs2{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 10px;align-items:center}
  .ux-tab2{padding:9px 12px;border:1px solid var(--stroke);border-radius:999px;background:transparent;color:var(--text);font-weight:800;cursor:pointer}
  .ux-tab2.is-active{background:rgba(255,255,255,.06)}
  .ux-panel2{display:none}
  .ux-panel2.is-active{display:block}
  .ux-chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
  .ux-chip{padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:transparent;color:var(--text);font-weight:800;cursor:pointer}
  .ux-chip:hover,.ux-tab2:hover{filter:brightness(1.08)}
  .ux-actions{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .ux-hint{color:var(--muted);font-weight:700;font-size:12px;line-height:1.35}
  /* Hide old top playlist buttons (they'll be accessible in Playlist tab) */
  #btnMy,#btnClear{display:none !important}

/* SPLIT_LISTS */
#listMy{max-height:420px;overflow:auto;-webkit-overflow-scrolling:touch;}
#listSearch{max-height:420px;overflow:auto;-webkit-overflow-scrolling:touch;}
</style>

<div class="ux-tabs2">
  <button type="button" class="ux-tab2 is-active" data-tab2="collections">–ü–æ–¥–±–æ—Ä–∫–∏</button>
  <button type="button" class="ux-tab2" data-tab2="search">–ü–æ–∏—Å–∫</button>
  <button type="button" class="ux-tab2" data-tab2="playlist">–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç</button>
</div>

<div class="ux-panel2 is-active" data-panel2="collections">
  <div class="ux-chips">
    <button type="button" class="ux-chip" data-preset="focus">Focus</button>
    <button type="button" class="ux-chip" data-preset="sleep">Sleep</button>
    <button type="button" class="ux-chip" data-preset="relax">Relax</button>
    <button type="button" class="ux-chip" data-preset="energise">Energise</button>
    <button type="button" class="ux-chip" data-preset="feelgood">Feel good</button>
    <button type="button" class="ux-chip" data-preset="workout">Workout</button>
  </div>
  <div class="ux-hint">–í—ã–±–µ—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Äî –º—ã –ø–æ–¥—Å—Ç–∞–≤–∏–º –∑–∞–ø—Ä–æ—Å –∏ –ø–æ–∫–∞–∂–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã. –î–∞–ª—å—à–µ –∂–º–∏ <b>‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –≤ Telegram</b>.</div>
</div>

<div class="ux-panel2" data-panel2="search">
  <div class="ux-hint">–í–≤–µ–¥–∏ <b>–∞—Ä—Ç–∏—Å—Ç–∞ –∏–ª–∏ —Ç—Ä–µ–∫</b> ‚Üí <b>–ù–∞–π—Ç–∏</b> ‚Üí <b>‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –≤ Telegram</b>. –°–∫–∞—á–∞–Ω–Ω–æ–µ –ø–æ–ø–∞–¥—ë—Ç –≤ <b>–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç</b>.</div>
</div>

<div class="ux-panel2" data-panel2="playlist">
  <div class="ux-actions">
    <button type="button" class="btn" id="uxBtnLoadMy">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</button>
    <button type="button" class="btn" id="uxBtnShuffleMy">üîÄ Shuffle</button>
    <button type="button" class="btn" id="uxBtnClearMy">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
  </div>
  <div class="ux-hint">–ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ —Ç–≤–æ—ë. –ú–æ–∂–Ω–æ –º–µ—à–∞—Ç—å, —Å–ª—É—à–∞—Ç—å –∏ —Å–∫–∞—á–∏–≤–∞—Ç—å –≤ Telegram.</div>
</div>

<!-- /UX: Clean Tabs (script moved into DOMContentLoaded) -->
    <div class="chips" id="chips">
      <div class="chip on" data-q="Energise">Energise</div>
      <div class="chip" data-q="Relax">Relax</div>
      <div class="chip" data-q="Feel good">Feel good</div>
      <div class="chip" data-q="Work out">Work out</div>
      <div class="chip" data-q="Focus">Focus</div>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>–ü–æ–¥–±–æ—Ä–∫–∞</h3>
        <div class="sub" id="subLeft">–ù–∞–∂–º–∏ —á–∏–ø –∏–ª–∏ –≤–≤–µ–¥–∏ –∑–∞–ø—Ä–æ—Å ‚Äî –ø–æ–∫–∞–∂—É –≤–∞—Ä–∏–∞–Ω—Ç—ã (–æ—Ä–∏–≥/—Ä–µ–º–∏–∫—Å—ã/–ª–∞–π–≤—ã)</div>
        <div class="list" id="listSearch"></div>
        <div class="list" id="listMy" style="display:none;"></div>
      </div>

      <div class="panel player">
        <h3>–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç</h3>
        <div class="modebar">
          <div class="modebtn on" id="modeAudio">Audio</div>
          <div class="modebtn" id="modeYT">YouTube</div>
        </div>
        <div class="playerbox">
          <div class="thumb" id="nowThumb"></div>
          <div class="now">
            <p class="t" id="nowTitle">–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ —Å–ª–µ–≤–∞</p>
            <div class="c" id="nowChan">‚Äî</div>
          </div>
        </div>
        <div style="padding:0 14px 14px; display:none" id="audioWrap">
          <audio id="aud" controls style="width:100%"></audio>
        </div>
        <div style="padding:12px 14px 14px;border-top:1px solid var(--stroke)">
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            
            
            <button class="btn" id="btnSendOneTG">‚¨áÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π</button>
            <button class="btn" id="btnSendPackTG">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É (6)</button>
            <button class="btn" id="btnOpenYT">‚ÜóÔ∏è –û—Ç–∫—Ä—ã—Ç—å –≤ YouTube</button>
          </div>
          <div style="margin-top:10px;color:var(--muted);font-weight:700;font-size:12px;line-height:1.35">
            <div id="uxSelHint">–í—ã–±—Ä–∞–Ω–æ: ‚Äî</div>
            <div id="uxPackHint">–ü–æ–¥–±–æ—Ä–∫–∞: ‚Äî</div>
          </div>
          <div style="margin-top:10px;color:var(--muted);font-weight:700;font-size:12px;line-height:1.35">
            ‚ö° –î–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º Telegram-–ø–ª–µ–µ—Ä (—Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç).
          </div>
        </div>
    </div>
  </div>

  <div class="footerbar">
    <div class="foot">
      <div class="status" id="status">–ì–æ—Ç–æ–≤–æ.</div>
      <div class="status" id="ver"></div>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', function(){
  try{ requestAnimationFrame(()=>document.body.classList.add('is-ready')); }catch(e){ document.body.classList.add('is-ready'); }
try{
  const $ = (id)=>document.getElementById(id);
  const listSearch = $("listSearch") || $("list");
  const listMy = $("listMy");
  let activeList = listSearch;
  const list = listSearch; // legacy alias (avoid crashes)

  // UX Tabs (safe): split Search vs My list
  try{
    const uxTabs = Array.from(document.querySelectorAll('[data-tab2]'));
    const uxPanels = Array.from(document.querySelectorAll('[data-panel2]'));

    function setUxTab(name){
      uxTabs.forEach(t=>t.classList.toggle('is-active', t.getAttribute('data-tab2')===name));
      uxPanels.forEach(p=>p.classList.toggle('is-active', p.getAttribute('data-panel2')===name));

      if (name === "playlist"){
        if (listSearch) listSearch.style.display = "none";
        if (listMy) listMy.style.display = "";
        activeList = listMy || listSearch;
        // auto load
        const btnMy = document.getElementById("btnMy");
        if (btnMy) btnMy.click();
      } else {
        if (listMy) listMy.style.display = "none";
        if (listSearch) listSearch.style.display = "";
        activeList = listSearch;
      }
      try{ updateUxHints(); }catch(e){}
    }

    uxTabs.forEach(t=>{
      t.addEventListener("click", ()=>{
        const name = t.getAttribute("data-tab2") || "search";
        setUxTab(name);
      });
    });

    // default view
    setUxTab("collections");
  }catch(e){}
 // legacy alias (avoid crashes)


  const status = $("status");
  const q = $("q");
  const aud = $("aud");
  const audioWrap = $("audioWrap");
  const iframeWrap = $("iframeWrap");
  const yt = $("yt");
  const modeAudio = $("modeAudio");
  const modeYT = $("modeYT");

  const nowTitle = $("nowTitle");
  const nowChan = $("nowChan");
  const nowThumb = $("nowThumb");
  const ver = $("ver");

  // Telegram WebApp safe init
  try {
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }
  } catch(e){}
  function getTgId(){
    try{
      const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

      // 1) initDataUnsafe
      const id1 = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
      if (id1) return Number(id1);

      // 2) parse initData: user=<urlencoded_json>
      const init = tg ? tg.initData : null;
      if (init){
        const params = new URLSearchParams(init);
        const u = params.get("user");
        if (u){
          try{
            const obj = JSON.parse(decodeURIComponent(u));
            if (obj && obj.id) return Number(obj.id);
          }catch(e){}
        }
      }
    }catch(e){}

    // 3) fallback query ?tg_id=
    try{
      const qp = new URLSearchParams(location.search);
      const qid = qp.get("tg_id");
      return qid ? parseInt(qid, 10) : null;
    }catch(e){}
    return null;
  }



  const _tgid = getTgId();



  function apiFetch(url, opts){
    const tg_id = getTgId();
    // –∞–≤—Ç–æ-–¥–æ–±–∞–≤–∫–∞ tg_id –≤ query (–¥–ª—è –±–µ–∫–µ–Ω–¥–∞)
    try{
      const u = new URL(url, location.origin);
      if (tg_id && !u.searchParams.get("tg_id")){
        u.searchParams.set("tg_id", String(tg_id));
      }
      url = u.toString();
    }catch(e){}

    opts = opts || {};
    const h = Object.assign({}, (opts.headers || {}));
    h["Accept"] = h["Accept"] || "application/json";
    if (tg_id){
      h["X-TG-ID"] = String(tg_id);
    }
    opts.headers = h;
    return fetch(url, opts);
  }
  const state = {
    activeEl: null,
    selected: null,
    lastQuery: "",
    items: [],
    queue: [],   // simple local queue (session)
    appVersion: (new URLSearchParams(location.search).get("v") || ""),
    mode: "audio",
    tg_id: _tgid,
    my: []
  };


  function setMode(m){
    state.mode = m;
    if (m === "audio"){
      modeAudio.classList.add("on");
      modeYT.classList.remove("on");
      if (audioWrap) audioWrap.style.display = "block";
      if (iframeWrap) iframeWrap.style.display = "none";
      if (yt) yt.src = "about:blank";
      if (iframeWrap) iframeWrap.classList.remove("active");
    } else {
      modeYT.classList.add("on");
      modeAudio.classList.remove("on");
      if (iframeWrap) iframeWrap.style.display = "block";
      if (audioWrap) audioWrap.style.display = "none";
      if (aud){ aud.pause(); aud.removeAttribute("src"); aud.load(); }
    }
  }

  modeAudio.addEventListener("click", ()=>setMode("audio"));
  modeYT.addEventListener("click", ()=>setMode("youtube"));
  setMode("audio");

  ver.textContent = state.appVersion ? ("v=" + state.appVersion) : "";

  function setStatus(t){ status.textContent = t; }

  

  function updateUxHints(){
    try{
      const a = document.getElementById("uxSelHint");
      const b = document.getElementById("uxPackHint");
      if (a){
        const t = state && state.selected ? (state.selected.title || "‚Äî") : "‚Äî";
        a.textContent = "–í—ã–±—Ä–∞–Ω–æ: " + t;
      }
      if (b){
        const qv = (q && q.value ? String(q.value).trim() : "") || (state && state.lastQuery ? String(state.lastQuery).trim() : "");
        b.textContent = "–ü–æ–¥–±–æ—Ä–∫–∞: " + (qv || "‚Äî");
      }
    }catch(e){}
  }
function esc(s){
    return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  function renderList(items, target){
    const L = target || activeList || listSearch;
    if (!L) return;
    L.innerHTML = "";
if (!items || !items.length){
      L.innerHTML = '<div style="padding:10px;color:var(--muted);font-weight:700">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à—ë–ª. –ü–æ–ø—Ä–æ–±—É–π —Ç–æ—á–Ω–µ–µ: ‚Äú–ê—Ä—Ç–∏—Å—Ç —Ç—Ä–µ–∫ remix‚Äù</div>';
      return;
    }
    for (const it of items){
      const el = document.createElement("div");
      el.className = "item";
      // stable key for highlighting / shuffle
      const _key = (it && it.kind === "my" && it.track_id) ? ("my:" + it.track_id) : (it && it.video_id ? ("yt:" + it.video_id) : ("t:" + (it.title||"")));
      el.dataset.trackKey = _key;
      if (it && it.track_id) el.dataset.trackId = String(it.track_id);
      else if (it && it.video_id) el.dataset.trackId = String(it.video_id);

      el.innerHTML = `
        <div class="thumb">${it.thumb ? `<img src="${esc(it.thumb)}" />` : ""}</div>
        <div class="meta">
          <div class="title">${esc(it.title)}</div>
          <div class="chan">${esc(it.channel)}</div>
        </div>
        <div class="tag">PLAY</div>
      `;
      el.addEventListener("click", ()=>play(it, el));
      L.appendChild(el);
    }
  }

  async function play(it, el){
    if (!it) return;

    function getKey(x){
      return (x && x.kind==="my" && x.track_id) ? ("my:" + x.track_id)
           : (x && x.video_id) ? ("yt:" + x.video_id)
           : ("t:" + (x && x.title ? x.title : ""));
    }

    function setActiveItem(node){
      try{
        if (state.activeEl) state.activeEl.classList.remove("is-active");
      }catch(e){}
      state.activeEl = node || null;
      if (state.activeEl) state.activeEl.classList.add("is-active");
    }

    // highlight: if called without el, try find by key
    try{
      const k = getKey(it);
      const node = el || document.querySelector('.item[data-track-key="'+k.replace(/"/g,'\"')+'"]');
      setActiveItem(node);
    }catch(e){}

    state.selected = it;
    state.queue.unshift(it);
    nowTitle.textContent = it.title || "‚Äî";
    nowChan.textContent = it.channel || "‚Äî";
    nowThumb.innerHTML = it.thumb ? `<img src="${esc(it.thumb)}" />` : "";
    // --- Audio mode ---
    // –í –≤–µ–±–∞–ø–∫–µ –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è "–∏–≥—Ä–∞—Ç—å" YouTube –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å.
    // –¢—Ä–µ–∫ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è, –∞ –¥–∞–ª—å—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–º—ë—Ç "‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –≤ Telegram" (–Ω–∞—à pipeline).
    if (state.mode === "audio"){
      // if this is a saved track from /my and we —Å–º–æ–≥–ª–∏ —Ä–µ–∑–æ–ª–≤–Ω—É—Ç—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É ‚Äî –æ–∫
      if (it.kind === "my" && it.track_id && state.tg_id){
        try{
          const u = new URL("/webapp/music/api/resolve", location.origin);
          u.searchParams.set("tg_id", String(state.tg_id));
          u.searchParams.set("track_id", String(it.track_id));
          const r = await apiFetch(u.toString(), { method:"GET" });
          const j = await r.json();
          const url = j && j.url ? j.url : null;
          if (url){
            aud.src = url;
            await aud.play().catch(()=>{});
            setStatus("üéß –ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–æ —Å–ª—É—à–∞—Ç—å –∏–ª–∏ —Å–∫–∞—á–∞—Ç—å –≤ Telegram.");
            return;
          }
        }catch(e){ console.error(e); }
      }
      setStatus("‚úÖ –í—ã–±—Ä–∞–Ω–æ. –ñ–º–∏ ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –≤ Telegram.");
      return;
    }

    // --- YouTube (–≤—Ç–æ—Ä–∏—á–Ω–æ, —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ "–û—Ç–∫—Ä—ã—Ç—å –≤ YouTube") ---
    setStatus("‚úÖ –í—ã–±—Ä–∞–Ω–æ. –ñ–º–∏ ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –≤ Telegram.");
    return;
}

  async function search(query){
    query = (query || "").trim();
    if (query.length < 2) return;
    state.lastQuery = query;
    setStatus("–ü–æ–∏—Å–∫: " + query + " ‚Ä¶");

    const u = new URL("/webapp/music/api/search", location.origin);
    u.searchParams.set("q", query);
    u.searchParams.set("limit", "14");

    try{
      const r = await apiFetch(u.toString(), { method:"GET" });
      const j = await r.json();
      const items = (j && j.items) ? j.items : [];
      state.items = items;
      activeList = listSearch;
      if (listMy) listMy.style.display = "none";
      if (listSearch) listSearch.style.display = "";
      renderList(items, listSearch);

      setStatus(items.length ? ("–ù–∞–π–¥–µ–Ω–æ: " + items.length) : "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
    }catch(e){
      console.error(e);
      setStatus("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞. –ü—Ä–æ–≤–µ—Ä—å API –∫–ª—é—á/—Å–µ—Ä–≤–µ—Ä.");
    }
  }

  // Debounce typing
  let t = null;
  q.addEventListener("input", ()=>{
    clearTimeout(t);
    t = setTimeout(()=>search(q.value), 450);
  });

  $("btnGo").addEventListener("click", ()=>search(q.value));
  
  
  // Presets (Focus/Sleep/...) ‚Äî —Å—Ç–∞–≤–∏–º –∑–∞–ø—Ä–æ—Å –∏ –∏—â–µ–º, –ù–ï –ø–µ—Ä–µ–∫–ª—é—á–∞—è –≤–∫–ª–∞–¥–∫—É
  document.querySelectorAll('.ux-chip[data-preset]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const p = (btn.getAttribute("data-preset") || "").trim();
      if (!p) return;
      const map = {
        focus: "Focus",
        sleep: "Sleep",
        relax: "Relax",
        energise: "Energise",
        feelgood: "Feel good",
        workout: "Workout"
      };
      const v = map[p] || p;
      if (q) q.value = v;
      search(v);
      setStatus("–ü–æ–¥–±–æ—Ä–∫–∞: " + v);
    });
  });
async function playInTelegram(){
    const it = state.selected;
    if (!it){
      setStatus("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫.");
      return;
    }

    const tg_id = getTgId();
    if (!tg_id){
      setStatus("–û—Ç–∫—Ä–æ–π mini app –≤–Ω—É—Ç—Ä–∏ Telegram (–Ω–µ—Ç tg_id).");
      return;
    }

    setStatus("–û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Telegram‚Ä¶");

    const u = new URL("/webapp/music/api/play", location.origin);

    // MY playlist ‚Üí track_id –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
    if (it.kind === "my" && it.track_id){
      u.searchParams.set("kind", "my");
      u.searchParams.set("track_id", String(it.track_id));
      let j = null;
      try{
        const r = await apiFetch(u.toString(), { method:"POST" });
        j = await r.json();
if (j && j.ok){
          setStatus("–û—Ç–ø—Ä–∞–≤–∏–ª –≤ Telegram ‚úÖ –û—Ç–∫—Ä–æ–π —á–∞—Ç ‚Äî —Ç—Ä–µ–∫ —É–∂–µ —Ç–∞–º.");
        } else {
          setStatus("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å –±–æ—Ç–∞/—Å–µ—Ä–≤–µ—Ä.");
        }
      }catch(e){
        console.error(e);
        if (j && (j.detail === "YTDLP_YT_BOT_CHECK")) { setStatus("YouTube –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ (anti-bot). –û—Ç–∫—Ä–æ–π –≤ YouTube ‚ÜóÔ∏è –∏–ª–∏ –¥–æ–±–∞–≤—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ mp3/ogg/m4a –≤ –ø–ª–µ–π–ª–∏—Å—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞."); return; }
    setStatus("–û—à–∏–±–∫–∞ /play. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ä–≤–µ—Ä.");
      }
      return;
    }

    // SEARCH item ‚Üí –ø—Ä–æ—Å–∏–º —Å–µ—Ä–≤–µ—Ä —Å–∫–∞—á–∞—Ç—å —Ñ—É–ª–ª (yt-dlp) –∏ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞—Ç—å file_id
    const title = (it.title || "").trim();
    const query = (title || (it.video_id ? ("https://www.youtube.com/watch?v=" + it.video_id) : "")).trim();

    if (!title || !query){
      setStatus("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.");
      return;
    }

    u.searchParams.set("kind", "search");
    u.searchParams.set("title", title);
    u.searchParams.set("query", query);
    // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ ‚Äî –¥–ª—è –ª–æ–≥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    if (it.video_id) u.searchParams.set("video_id", String(it.video_id));

    try{
      const r = await apiFetch(u.toString(), { method:"POST" });
      const j = await r.json();
      if (j && j.ok){
        setStatus("–û—Ç–ø—Ä–∞–≤–∏–ª –≤ Telegram ‚úÖ –û—Ç–∫—Ä–æ–π —á–∞—Ç ‚Äî —Ñ—É–ª–ª-—Ç—Ä–µ–∫ —É–∂–µ —Ç–∞–º.");
      } else {
        setStatus("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ä–≤–µ—Ä.");
      }
    }catch(e){
      console.error(e);
      setStatus("–û—à–∏–±–∫–∞ /play (search). –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ä–≤–µ—Ä/yt-dlp.");
    }
  }


  function openInYouTube(){
    const it = state.selected;
    if (!it || !it.video_id){
      setStatus("–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ –∏–∑ –ø–æ–∏—Å–∫–∞ YouTube.");
      return;
    }
    const url = "https://www.youtube.com/watch?v=" + encodeURIComponent(it.video_id);
    try{
      const tg = window.Telegram && Telegram.WebApp ? Telegram.WebApp : null;
      if (tg && tg.openLink){
        tg.openLink(url);
      } else {
        window.open(url, "_blank");
      }
    }catch(e){
      window.open(url, "_blank");
    }
    setStatus("–û—Ç–∫—Ä—ã–ª YouTube ‚ÜóÔ∏è");
  }
  async function sendSelectedToTelegram(){
    const it = state.selected;
    if (!it){ setStatus("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞."); return; }

    const tg_id = getTgId();
    if (!tg_id){ setStatus("–û—Ç–∫—Ä–æ–π mini app –≤–Ω—É—Ç—Ä–∏ Telegram (–Ω–µ—Ç tg_id)."); return; }

    setStatus("–û—Ç–ø—Ä–∞–≤–ª—è—é –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç—Ä–µ–∫ –≤ Telegram‚Ä¶");

    // MY playlist
    if (it.kind === "my" && it.track_id){
      const u = new URL("/webapp/music/api/play", location.origin);
      u.searchParams.set("kind", "my");
      u.searchParams.set("track_id", String(it.track_id));
      try{
        const r = await apiFetch(u.toString(), { method:"POST" });
        const j = await r.json();
        if (j && j.ok){
          setStatus("–û—Ç–ø—Ä–∞–≤–∏–ª –≤—ã–±—Ä–∞–Ω–Ω—ã–π ‚úÖ –û—Ç–∫—Ä–æ–π —á–∞—Ç ‚Äî —Ç—Ä–µ–∫ —É–∂–µ —Ç–∞–º.");
        } else {
          setStatus("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ä–≤–µ—Ä.");
        }
      }catch(e){
        console.error(e);
        setStatus("–û—à–∏–±–∫–∞ /play (my).");
      }
      return;
    }

    // SEARCH item -> –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π (–Ω–µ –ø–∞—á–∫–æ–π)
    const title = (it.title || "").trim();
    const query = it.video_id ? ("https://www.youtube.com/watch?v=" + it.video_id) : title;

    if (!title || !query){
      setStatus("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–∞. –í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.");
      return;
    }

    const u = new URL("/webapp/music/api/play", location.origin);
    u.searchParams.set("kind", "search");
    u.searchParams.set("title", title);
    u.searchParams.set("query", query);
    if (it.video_id) u.searchParams.set("video_id", String(it.video_id));

    try{
      const r = await apiFetch(u.toString(), { method:"POST" });
      const j = await r.json();
      if (j && j.ok){
        setStatus("–û—Ç–ø—Ä–∞–≤–∏–ª –≤—ã–±—Ä–∞–Ω–Ω—ã–π ‚úÖ –û—Ç–∫—Ä–æ–π —á–∞—Ç ‚Äî —Ç—Ä–µ–∫ —É–∂–µ —Ç–∞–º.");
      } else {
        setStatus("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ä–≤–µ—Ä.");
      }
    }catch(e){
      console.error(e);
      setStatus("–û—à–∏–±–∫–∞ /play (selected).");
    }
  }

  async function sendBulkToTelegram(){

    const tg_id = getTgId();
    const queryRaw = (q && q.value ? String(q.value) : "").trim();
    const query = queryRaw || (state.selected && state.selected.title ? String(state.selected.title).trim() : "");
    if (!query || query.length < 2){ setStatus("–í–≤–µ–¥–∏ –∑–∞–ø—Ä–æ—Å (–º–∏–Ω 2 —Å–∏–º–≤–æ–ª–∞)."); return; }
    if (!tg_id){ setStatus("–û—Ç–∫—Ä–æ–π mini app –≤–Ω—É—Ç—Ä–∏ Telegram (–Ω–µ—Ç tg_id)."); return; }

    const lim = 6; // —Å–µ—Ä–≤–µ—Ä –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç MUSIC_SEND_LIMIT/limit<=10
    const strictAuto = (query.split(/\s+/).filter(Boolean).length >= 2);

    setStatus("–û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Telegram‚Ä¶");

    const u = new URL("/webapp/music/api/tg_pipeline", location.origin);
    u.searchParams.set("q", query);
    u.searchParams.set("limit", String(lim));
    u.searchParams.set("strict", strictAuto ? "true" : "false");

    try{
      const r = await apiFetch(u.toString(), { method:"POST" });
      const j = await r.json();
      const items = (j && j.sent_items) ? j.sent_items : [];
      const okCnt = items.filter(x => x && x.tg_copyMessage && x.tg_copyMessage.ok).length;

      if (j && j.sent){
        setStatus(`‚úÖ –í TG: ${okCnt}/${items.length} (strict=${strictAuto ? "on":"off"})`);
      } else {
        setStatus("‚ö†Ô∏è –ù–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å (—Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞).");
      }
    }catch(e){
      console.error(e);
      setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ /tg_pipeline");
    }
  }
$("btnOpenYT").addEventListener("click", openInYouTube);



  $("btnSendOneTG")?.addEventListener("click", sendSelectedToTelegram);
  $("btnSendPackTG")?.addEventListener("click", sendBulkToTelegram);
  updateUxHints();
$("btnClear").addEventListener("click", ()=>{
  q.value = "";
  if (listSearch) listSearch.innerHTML = "";
  if (listMy) listMy.innerHTML = "";
  if (yt) yt.src = "about:blank";
  if (iframeWrap) iframeWrap.classList.remove("active");
  nowTitle.textContent = "–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ —Å–ª–µ–≤–∞";
  nowChan.textContent = "‚Äî";
  nowThumb.innerHTML = "";
  state.selected = null;
  setStatus("–û—á–∏—â–µ–Ω–æ.");
});

  async function loadMy(){
  if (!state.tg_id){
    setStatus("–û—Ç–∫—Ä–æ–π mini app –≤–Ω—É—Ç—Ä–∏ Telegram (–Ω–µ—Ç tg_id).");
    return;
  }
  setStatus("–ó–∞–≥—Ä—É–∂–∞—é —Ç–≤–æ–π –ø–ª–µ–π–ª–∏—Å—Ç‚Ä¶");
  const u = new URL("/webapp/music/api/my", location.origin);
  u.searchParams.set("tg_id", String(state.tg_id));

  try{
    const r = await apiFetch(u.toString(), { method:"GET" });
    const j = await r.json();
    const items = (j && j.items) ? j.items : [];

    state.my = items.map(x=>({
      kind: "my",
      track_id: x.id,
      title: x.title || "Track",
      channel: "My playlist",
      thumb: "",
      is_url: !!x.is_url,
      file_id: x.file_id || ""
    }));

    const target = listMy || listSearch;
    if (target) target.innerHTML = "";

    if (!state.my.length){
      if (target) target.innerHTML =
        '<div style="padding:10px;color:var(--muted);font-weight:700">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –∞—É–¥–∏–æ –≤ –±–æ—Ç–µ –∏–ª–∏ –ø–æ https-—Å—Å—ã–ª–∫–µ mp3/ogg/m4a.</div>';
      setStatus("–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç.");
      return;
    }

    renderList(state.my, listMy || listSearch);
    setStatus("–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç: " + state.my.length);
  }catch(e){
    console.error(e);
    setStatus("–û—à–∏–±–∫–∞ /my. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ä–≤–µ—Ä.");
  }
}
  // UX playlist buttons
  document.getElementById("uxBtnLoadMy")?.addEventListener("click", loadMy);
  document.getElementById("btnMy")?.addEventListener("click", loadMy);

  document.getElementById("uxBtnClearMy")?.addEventListener("click", ()=>{
    state.my = [];
    if (listMy) listMy.innerHTML = '<div style="padding:10px;color:var(--muted);font-weight:700">–ü–ª–µ–π–ª–∏—Å—Ç –æ—á–∏—â–µ–Ω. –î–æ–±–∞–≤—å –Ω–æ–≤—ã–µ —Ç—Ä–µ–∫–∏ –≤ –±–æ—Ç–µ.</div>';
    setStatus("–ü–ª–µ–π–ª–∏—Å—Ç –æ—á–∏—â–µ–Ω ‚úÖ");
  });

  document.getElementById("uxBtnShuffleMy")?.addEventListener("click", ()=>{
    if (!state.my || !state.my.length){
      setStatus("–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç.");
      return;
    }
    const arr = state.my.slice();
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      const tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
    }
    state.my = arr;
    renderList(state.my, listMy || listSearch);
    setStatus("Shuffle ‚úÖ");
  });

} catch(e){
  console.error(e);
  const s = document.getElementById("status");
  if (s) s.textContent = "JS error: " + (e && e.message ? e.message : e);
}
});
</script>




</body>
</html>
