<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta charset="UTF-8" />
  <title>ValFlow Music</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f0f12;
      --card:#151520;
      --stroke:#26263a;
      --muted:rgba(255,255,255,.72);
      --text:#fff;
      --btn:#2b78ff;
      --btn2:#2a2a38;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui;padding:18px;}
    .top{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
    .h1{font-size:22px;font-weight:800;}
    .sub{font-size:15px;color:var(--muted);}
    .row{background:var(--card);border:1px solid var(--stroke);border-radius:18px;padding:14px;margin:10px 0;}
    .title{font-size:18px;font-weight:800;}
    .meta{font-size:14px;color:var(--muted);margin-top:6px;}
    .player{width:100%;margin-top:10px;}
    .btns{margin-top:10px;}
    button{border:0;border-radius:14px;padding:12px 14px;font-size:16px;font-weight:700;color:#fff;background:var(--btn);}
    .error{color:#ffd0d0;}
    .empty{border:1px dashed var(--stroke);border-radius:18px;padding:16px;color:var(--muted);}
  </style>
</head>

<body>
  <div class="top">
    <div class="h1">üéµ –ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç</div>
    <div class="sub" id="subtitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </div>

  <div class="error" id="error" style="display:none"></div>
  <div id="list"></div>

<script>
(function(){
  const tg = window.Telegram?.WebApp || null;
  tg?.ready?.();

  const subtitle = document.getElementById('subtitle');
  const errorBox = document.getElementById('error');
  const list = document.getElementById('list');

  function showError(msg){
    errorBox.style.display='block';
    errorBox.textContent=msg;
    subtitle.textContent='–û—à–∏–±–∫–∞';
  }

  function sendPlay(id){
    try{ tg?.sendData(JSON.stringify({action:'play',id})) }catch(e){}
  }

  function render(items){
    list.innerHTML='';
    if(!items?.length){
      subtitle.textContent='–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç';
      list.innerHTML='<div class="empty">–î–æ–±–∞–≤—å —Ç—Ä–µ–∫ –≤ –±–æ—Ç–µ</div>';
      return;
    }
    subtitle.textContent=`–¢—Ä–µ–∫–æ–≤: ${items.length}`;
    for(const it of items){
      const r=document.createElement('div');r.className='row';
      r.innerHTML=`<div class="title">${it.title||'Track'}</div>
                   <div class="meta">${it.is_url?'–ò—Å—Ç–æ—á–Ω–∏–∫: —Å—Å—ã–ª–∫–∞':'–ò—Å—Ç–æ—á–Ω–∏–∫: Telegram'}</div>`;
      if(it.is_url){
        const a=document.createElement('audio');
        a.controls=true;a.src=it.file_id;a.className='player';
        r.appendChild(a);
      }
      const b=document.createElement('div');b.className='btns';
      b.innerHTML='<button>‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å –≤ Telegram</button>';
      b.firstChild.onclick=()=>sendPlay(it.id);
      r.appendChild(b);
      list.appendChild(r);
    }
  }

  const tgId = tg?.initDataUnsafe?.user?.id;
  if(!tgId){ showError('–û—Ç–∫—Ä–æ–π –ø–ª–µ–µ—Ä –∏–∑ Telegram'); return; }

  const v = new URLSearchParams(window.location.search).get('v') || String(Date.now());
  fetch(`/webapp/music/api/my?tg_id=${tgId}&v=${encodeURIComponent(v)}`, { cache: 'no-store' })
    .then(r=>r.ok?r.json():Promise.reject(r.status))
    .then(j=>render(j.items))
    .catch(e=>showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞'));
})();
</script>
</body>
</html>
