<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Diary Music</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --card2:#0f1622;
      --text:#e9eef6;
      --muted:#9aa7b8;
      --stroke:#1f2a3a;
      --chip:#162033;
      --chipOn:#24324a;
      --accent:#3aa0ff;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background: radial-gradient(900px 500px at 20% -10%, rgba(58,160,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 120% 0%, rgba(120,80,255,.22), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px 16px 90px;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px 4px 10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700; letter-spacing:.2px;
    }
    .logo{
      width:34px;height:34px;border-radius:10px;
      background: linear-gradient(135deg, rgba(58,160,255,.95), rgba(120,80,255,.9));
      box-shadow: var(--shadow);
    }
    .brand small{display:block;color:var(--muted);font-weight:600;letter-spacing:.3px}
    .actions{display:flex;align-items:center;gap:10px}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:active{transform:translateY(1px)}
    .search{
      display:flex; gap:10px;
      padding:12px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius: var(--r);
      box-shadow: var(--shadow);
    }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
      color:var(--text);
      font-size:16px;
    }
    .chips{
      display:flex;
      gap:8px;
      overflow:auto;
      padding:12px 2px 0;
      -webkit-overflow-scrolling: touch;
    }
    .chip{
      white-space:nowrap;
      border:1px solid var(--stroke);
      background: var(--chip);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      opacity:.95;
    }
    .chip.on{background:var(--chipOn); border-color: rgba(58,160,255,.35)}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.35fr 1fr;
      gap:14px;
    }
    @media (max-width:860px){
      .grid{grid-template-columns:1fr}
    }
    .panel{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel h3{
      margin:0;
      padding:14px 14px 10px;
      font-size:16px;
      letter-spacing:.2px;
    }
    .panel .sub{
      padding:0 14px 12px;
      color:var(--muted);
      font-weight:600;
      font-size:13px;
    }
    .list{
      border-top:1px solid var(--stroke);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 420px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .item{
      display:flex;
      gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,.05);
      background: rgba(17,24,36,.55);
      border-radius:14px;
      cursor:pointer;
    }
    .thumb{
      width:70px;height:70px;border-radius:12px;
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
      overflow:hidden;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{min-width:0;flex:1}
    .title{
      font-weight:800;
      font-size:14px;
      line-height:1.25;
      margin:2px 0 6px;
      overflow:hidden;

      /* standard (–≥–¥–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è) */
      line-clamp: 2;

      /* webkit fallback (Telegram iOS / Safari) */
      display:-webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;

      /* fallback –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è clamp */
      max-height: 2.5em;
      }
    .chan{
      color:var(--muted);
      font-weight:700;
      font-size:12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .tag{
      margin-left:auto;
      align-self:flex-start;
      font-size:11px;
      font-weight:800;
      color: rgba(58,160,255,.95);
      border:1px solid rgba(58,160,255,.25);
      padding:5px 8px;
      border-radius:999px;
      background: rgba(58,160,255,.08);
    }

    .player{
      padding:0;
    }
    .playerbox{
      padding:14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .now{
      min-width:0; flex:1;
    }
    .now .t{font-weight:900;margin:0 0 6px;font-size:15px;line-height:1.25}
    .now .c{color:var(--muted);font-weight:700;font-size:12px}
    .iframe{
      border-top:1px solid var(--stroke);
      background: rgba(0,0,0,.2);
      aspect-ratio: 16/9;
      width:100%;
    }
    iframe{width:100%;height:100%;border:0;display:block}

    .footerbar{
      position:fixed;
      left:0;right:0;bottom:0;
      padding:10px 12px;
      background: rgba(9,12,16,.7);
      border-top:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(12px);
    }
    .foot{
      max-width:980px;margin:0 auto;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    
    .modebar{
      display:flex; gap:8px; padding:0 14px 12px;
    }
    .modebtn{
      border:1px solid var(--stroke);
      background: var(--chip);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      opacity:.95;
      font-size:12px;
    }
    .modebtn.on{background:var(--chipOn); border-color: rgba(58,160,255,.35)}
.status{color:var(--muted);font-weight:700;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  
.iframe{pointer-events:none;}
.iframe.active{pointer-events:auto;}
</style>

</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          Diary Music
          <small>–ø–æ–∏—Å–∫ —Ç—Ä–µ–∫–æ–≤, —Ä–µ–º–∏–∫—Å–æ–≤ –∏ –≤–µ—Ä—Å–∏–π</small>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnMy">–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç</button>
        <button class="btn" id="btnClear">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <div class="search">
      <input id="q" placeholder="–ê—Ä—Ç–∏—Å—Ç + —Ç—Ä–µ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Luxor 100 –ø—Ä–∏—á–∏–Ω)" autocomplete="off" />
      <button class="btn" id="btnGo">–ù–∞–π—Ç–∏</button>
    </div>

    <div class="chips" id="chips">
      <div class="chip on" data-q="Energise">Energise</div>
      <div class="chip" data-q="Relax">Relax</div>
      <div class="chip" data-q="Feel good">Feel good</div>
      <div class="chip" data-q="Work out">Work out</div>
      <div class="chip" data-q="Focus">Focus</div>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>–ü–æ–¥–±–æ—Ä–∫–∞</h3>
        <div class="sub" id="subLeft">–ù–∞–∂–º–∏ —á–∏–ø –∏–ª–∏ –≤–≤–µ–¥–∏ –∑–∞–ø—Ä–æ—Å ‚Äî –ø–æ–∫–∞–∂—É –≤–∞—Ä–∏–∞–Ω—Ç—ã (–æ—Ä–∏–≥/—Ä–µ–º–∏–∫—Å—ã/–ª–∞–π–≤—ã)</div>
        <div class="list" id="list"></div>
      </div>

      <div class="panel player">
        <h3>–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç</h3>
        <div class="modebar">
          <div class="modebtn on" id="modeAudio">Audio</div>
          <div class="modebtn" id="modeYT">YouTube</div>
        </div>
        <div class="playerbox">
          <div class="thumb" id="nowThumb"></div>
          <div class="now">
            <p class="t" id="nowTitle">–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ —Å–ª–µ–≤–∞</p>
            <div class="c" id="nowChan">‚Äî</div>
          </div>
        </div>
        <div style="padding:0 14px 14px; display:none" id="audioWrap">
          <audio id="aud" controls style="width:100%"></audio>
        </div>
        <div style="padding:12px 14px 14px;border-top:1px solid var(--stroke)">
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" id="btnPlayTG">‚ñ∂Ô∏è Play –≤ Telegram</button>
            <button class="btn" id="btnOpenYT">‚ÜóÔ∏è –û—Ç–∫—Ä—ã—Ç—å –≤ YouTube</button>
          </div>
          <div style="margin-top:10px;color:var(--muted);font-weight:700;font-size:12px;line-height:1.35">
            ‚ö° –î–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º Telegram-–ø–ª–µ–µ—Ä (—Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç).
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footerbar">
    <div class="foot">
      <div class="status" id="status">–ì–æ—Ç–æ–≤–æ.</div>
      <div class="status" id="ver"></div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const list = $("list");
  const status = $("status");
  const q = $("q");
  const aud = $("aud");
  const audioWrap = $("audioWrap");
  const iframeWrap = $("iframeWrap");
  const modeAudio = $("modeAudio");
  const modeYT = $("modeYT");

  const nowTitle = $("nowTitle");
  const nowChan = $("nowChan");
  const nowThumb = $("nowThumb");
  const ver = $("ver");

  // Telegram WebApp safe init
  try {
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }
  } catch(e){}

  function getTgId(){
    try{
      const tg = window.Telegram && Telegram.WebApp ? Telegram.WebApp : null;
      const id = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
      if (id) return id;
    }catch(e){}
    const qp = new URLSearchParams(location.search);
    const qid = qp.get("tg_id");
    return qid ? parseInt(qid, 10) : null;
  }

  state.tg_id = getTgId();

  function setMode(m){
    state.mode = m;
    if (m === "audio"){
      modeAudio.classList.add("on");
      modeYT.classList.remove("on");
      audioWrap.style.display = "block";
      iframeWrap.style.display = "none";
      yt.src = "about:blank";
    iframeWrap.classList.remove("active");
    } else {
      modeYT.classList.add("on");
      modeAudio.classList.remove("on");
      iframeWrap.style.display = "block";
      audioWrap.style.display = "none";
      aud.pause();
      aud.removeAttribute("src");
      aud.load();
    }
  }

  modeAudio.addEventListener("click", ()=>setMode("audio"));
  modeYT.addEventListener("click", ()=>setMode("youtube"));
  setMode("audio");


  const state = {
    selected: null,
    lastQuery: "",
    items: [],
    queue: [],   // simple local queue (session)
    appVersion: (new URLSearchParams(location.search).get("v") || ""),
    mode: "audio",
    tg_id: null,
    my: []
  };
  ver.textContent = state.appVersion ? ("v=" + state.appVersion) : "";

  function setStatus(t){ status.textContent = t; }

  function esc(s){
    return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  function renderList(items){
    list.innerHTML = "";
    if (!items || !items.length){
      list.innerHTML = '<div style="padding:10px;color:var(--muted);font-weight:700">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à—ë–ª. –ü–æ–ø—Ä–æ–±—É–π —Ç–æ—á–Ω–µ–µ: ‚Äú–ê—Ä—Ç–∏—Å—Ç —Ç—Ä–µ–∫ remix‚Äù</div>';
      return;
    }
    for (const it of items){
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="thumb">${it.thumb ? `<img src="${esc(it.thumb)}" />` : ""}</div>
        <div class="meta">
          <div class="title">${esc(it.title)}</div>
          <div class="chan">${esc(it.channel)}</div>
        </div>
        <div class="tag">PLAY</div>
      `;
      el.addEventListener("click", ()=>play(it));
      list.appendChild(el);
    }
  }

  async function play(it){
    if (!it) return;
    state.queue.unshift(it);
    nowTitle.textContent = it.title || "‚Äî";
    nowChan.textContent = it.channel || "‚Äî";
    nowThumb.innerHTML = it.thumb ? `<img src="${esc(it.thumb)}" />` : "";

    // --- Audio mode (works best for "My playlist") ---
    if (state.mode === "audio"){
      // if this is a saved track from /my
      if (it.kind === "my" && it.track_id && state.tg_id){
        try{
          const u = new URL("/webapp/music/api/resolve", location.origin);
          u.searchParams.set("tg_id", String(state.tg_id));
          u.searchParams.set("track_id", String(it.track_id));
          const r = await fetch(u.toString(), { method:"GET", headers:{ "Accept":"application/json" } });
          const j = await r.json();
          const url = j && j.url ? j.url : null;
          if (url){
            aud.src = url;
            await aud.play().catch(()=>{});
            setStatus("üéß Audio: " + (it.title || "Playing"));
            return;
          }
        }catch(e){
          console.error(e);
        }
        setStatus("Audio –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –û—Ç–∫—Ä–æ–π —Ç—Ä–µ–∫ –≤ YouTube –∏–ª–∏ –¥–æ–±–∞–≤—å https mp3/ogg/m4a.");
      }

      // fallback: for search items we don't have audio -> preview on YouTube
      setMode("youtube");
    }

    // --- YouTube mode ---
    if (!it.video_id) return;
    const src = "https://www.youtube.com/embed/" + encodeURIComponent(it.video_id) + "?autoplay=1&rel=0";
    yt.src = src;
    setStatus("‚ñ∂Ô∏è YouTube: " + (it.title || "Playing"));
  }

  async function search(query){
    query = (query || "").trim();
    if (query.length < 2) return;
    state.lastQuery = query;
    setStatus("–ü–æ–∏—Å–∫: " + query + " ‚Ä¶");

    const u = new URL("/webapp/music/api/search", location.origin);
    u.searchParams.set("q", query);
    u.searchParams.set("limit", "14");

    try{
      const r = await fetch(u.toString(), { method:"GET", headers:{ "Accept":"application/json" } });
      const j = await r.json();
      const items = (j && j.items) ? j.items : [];
      state.items = items;
      renderList(items);
      setStatus(items.length ? ("–ù–∞–π–¥–µ–Ω–æ: " + items.length) : "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
    }catch(e){
      console.error(e);
      setStatus("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞. –ü—Ä–æ–≤–µ—Ä—å API –∫–ª—é—á/—Å–µ—Ä–≤–µ—Ä.");
    }
  }

  // Debounce typing
  let t = null;
  q.addEventListener("input", ()=>{
    clearTimeout(t);
    t = setTimeout(()=>search(q.value), 450);
  });

  $("btnGo").addEventListener("click", ()=>search(q.value));
  
  async function playInTelegram(){
    const it = state.selected;
    if (!it){
      setStatus("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫.");
      return;
    }
    if (it.kind !== "my" || !it.track_id){
      setStatus("–î–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–æ–±–∞–≤—å —Ç—Ä–µ–∫ –≤ –ø–ª–µ–π–ª–∏—Å—Ç (—á–µ—Ä–µ–∑ –±–æ—Ç–∞).");
      return;
    }
    const tg_id = getTgId();
    if (!tg_id){
      setStatus("–û—Ç–∫—Ä–æ–π mini app –≤–Ω—É—Ç—Ä–∏ Telegram (–Ω–µ—Ç tg_id).");
      return;
    }
    setStatus("–û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Telegram‚Ä¶");
    const u = new URL("/webapp/music/api/play", location.origin);
    u.searchParams.set("tg_id", String(tg_id));
    u.searchParams.set("track_id", String(it.track_id));
    try{
      const r = await fetch(u.toString(), { method:"POST", headers:{ "Accept":"application/json" } });
      const j = await r.json();
      if (j && j.ok){
        setStatus("–û—Ç–ø—Ä–∞–≤–∏–ª –≤ Telegram ‚úÖ –û—Ç–∫—Ä–æ–π —á–∞—Ç ‚Äî —Ç—Ä–µ–∫ —É–∂–µ —Ç–∞–º.");
      } else {
        setStatus("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å –±–æ—Ç–∞/—Å–µ—Ä–≤–µ—Ä.");
      }
    }catch(e){
      console.error(e);
      setStatus("–û—à–∏–±–∫–∞ /play. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ä–≤–µ—Ä.");
    }
  }

  function openInYouTube(){
    const it = state.selected;
    if (!it || !it.video_id){
      setStatus("–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ –∏–∑ –ø–æ–∏—Å–∫–∞ YouTube.");
      return;
    }
    const url = "https://www.youtube.com/watch?v=" + encodeURIComponent(it.video_id);
    try{
      const tg = window.Telegram && Telegram.WebApp ? Telegram.WebApp : null;
      if (tg && tg.openLink){
        tg.openLink(url);
      } else {
        window.open(url, "_blank");
      }
    }catch(e){
      window.open(url, "_blank");
    }
    setStatus("–û—Ç–∫—Ä—ã–ª YouTube ‚ÜóÔ∏è");
  }

  $("btnPlayTG").addEventListener("click", playInTelegram);
  $("btnOpenYT").addEventListener("click", openInYouTube);

$("btnClear").addEventListener("click", ()=>{
    q.value = "";
    list.innerHTML = "";
    yt.src = "about:blank";
    iframeWrap.classList.remove("active");
    nowTitle.textContent = "–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ —Å–ª–µ–≤–∞";
    nowChan.textContent = "‚Äî";
    nowThumb.innerHTML = "";
    state.selected = null;
    setStatus("–û—á–∏—â–µ–Ω–æ.");
  });

  async function loadMy(){
    if (!state.tg_id){
      setStatus("–û—Ç–∫—Ä–æ–π mini app –≤–Ω—É—Ç—Ä–∏ Telegram (–Ω–µ—Ç tg_id).");
      return;
    }
    setStatus("–ó–∞–≥—Ä—É–∂–∞—é —Ç–≤–æ–π –ø–ª–µ–π–ª–∏—Å—Ç‚Ä¶");
    const u = new URL("/webapp/music/api/my", location.origin);
    u.searchParams.set("tg_id", String(state.tg_id));
    try{
      const r = await fetch(u.toString(), { method:"GET", headers:{ "Accept":"application/json" } });
      const j = await r.json();
      const items = (j && j.items) ? j.items : [];
      state.my = items.map(x=>({
        kind: "my",
        track_id: x.id,
        title: x.title || "Track",
        channel: "My playlist",
        thumb: "",
        is_url: !!x.is_url,
        file_id: x.file_id || ""
      }));
      // render
      list.innerHTML = "";
      if (!state.my.length){
        list.innerHTML = '<div style="padding:10px;color:var(--muted);font-weight:700">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –∞—É–¥–∏–æ –≤ –±–æ—Ç–µ –∏–ª–∏ –ø–æ https-—Å—Å—ã–ª–∫–µ mp3/ogg/m4a.</div>';
        setStatus("–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç.");
        return;
      }
      // custom render for my: show PLAY
      renderList(state.my);
      setStatus("–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç: " + state.my.length);
    }catch(e){
      console.error(e);
      setStatus("–û—à–∏–±–∫–∞ /my. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ä–≤–µ—Ä.");
    }
  }

  // "–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç" ‚Äî –≥—Ä—É–∑–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞
  $("btnMy").addEventListener("click", loadMy);

  // chips
  const chips = $("chips");
  chips.addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip");
    if (!chip) return;
    for (const x of chips.querySelectorAll(".chip")) x.classList.remove("on");
    chip.classList.add("on");
    const v = chip.getAttribute("data-q") || "";
    q.value = v;
    search(v);
  });

  // initial
  search("Energise");
})();
</script>
</body>
</html>
