<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meditation</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; padding: 16px; margin: 0; }
    .box { max-width: 560px; margin: 0 auto; }
    h2 { margin: 0 0 12px; }
    .card { border: 1px solid rgba(127,127,127,.25); border-radius: 16px; padding: 14px; margin: 10px 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .row5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .btn { padding: 12px 10px; font-size: 15px; border-radius: 12px; border: 1px solid rgba(127,127,127,.35); background: rgba(127,127,127,.08); }
    .btn.primary { font-weight: 700; }
    .btn.active { outline: 2px solid rgba(0, 128, 255, .55); }
    .big { font-size: 26px; text-align: center; padding: 12px 0; }
    .muted { opacity: .7; font-size: 13px; line-height: 1.35; }
    label { font-size: 13px; opacity: .85; display: block; margin-bottom: 6px; }
    input[type="range"] { width: 100%; }
    .status { font-size: 14px; }
    .ok { color: #18a558; font-weight: 700; }
    .warn { color: #d97706; font-weight: 700; }
  </style>
</head>
<body>
  <div class="box">
    <h2>üßò –ú–µ–¥–∏—Ç–∞—Ü–∏—è</h2>

    <div class="card">
      <div class="big" id="timeLeft">–ì–æ—Ç–æ–≤</div>
      <div class="status" id="status">–ù–∞—Å—Ç—Ä–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏ Start.</div>
      <div class="muted" style="margin-top:10px">
        –í–∞–∂–Ω–æ: –≤ Telegram –Ω—É–∂–µ–Ω 1 –∫–ª–∏–∫ ‚ÄúStart‚Äù, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä —Ä–∞–∑—Ä–µ—à–∏–ª –∑–≤—É–∫. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∫–æ–ª–æ–∫–æ–ª/—Ñ–æ–Ω —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
      </div>
    </div>

    <div class="card">
      <label>‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
      <div class="row5" id="durRow">
        <button class="btn" data-min="5">5</button>
        <button class="btn" data-min="10">10</button>
        <button class="btn" data-min="15">15</button>
        <button class="btn" data-min="20">20</button>
        <button class="btn" id="durCustomBtn">–ö–∞—Å—Ç–æ–º</button>
      </div>
      <div style="margin-top:10px">
        <input id="durCustom" type="number" min="1" max="180" step="1" value="10" style="width:100%; padding:12px; border-radius:12px; border:1px solid rgba(127,127,127,.35); display:none;">
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>üéõ –†–µ–∂–∏–º</label>
          <div class="row3" id="modeRow">
            <button class="btn" data-mode="timer">Timer</button>
            <button class="btn" data-mode="guided">Guided</button>
            <button class="btn" data-mode="sleep">Sleep</button>
          </div>
        </div>
        <div>
          <label>üîî –ö–æ–ª–æ–∫–æ–ª</label>
          <div class="row">
            <button class="btn" id="bellToggle">On</button>
            <button class="btn" id="testSound">–¢–µ—Å—Ç</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <label>üéµ –§–æ–Ω</label>
      <div class="row" id="bgRow">
        <button class="btn" data-bg="off">Off</button>
        <button class="btn" data-bg="rain">Rain</button>
        <button class="btn" data-bg="forest">Forest</button>
        <button class="btn" data-bg="white">White</button>
      </div>

      <div style="margin-top:12px">
        <label>üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å: <span id="volLabel">70%</span></label>
        <input id="vol" type="range" min="0" max="100" value="70">
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button class="btn primary" id="startBtn">‚ñ∂Ô∏è Start</button>
        <button class="btn" id="pauseBtn" disabled>‚è∏ Pause</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="resumeBtn" disabled>‚ñ∂Ô∏è Resume</button>
        <button class="btn" id="stopBtn" disabled>‚èπ Stop</button>
      </div>
    </div>
  
<audio id="bellStart" src="/static/sounds/meditation_start.mp3" preload="auto"></audio>
<audio id="bellEnd" src="/static/sounds/meditation_end.mp3" preload="auto"></audio>


    </div>

  <script>
  (() => {
    // --- Telegram WebApp ---
    const tg = window.Telegram?.WebApp;
    try { tg?.ready?.(); tg?.expand?.(); } catch(e) {}

    function send(type, payload={}) {
      try { tg?.sendData?.(JSON.stringify({ type, ...payload })); } catch(e) {}
    }

    // --- Query params for prefill (from bot) ---
    function qs(name, defVal=null){
      const u = new URL(window.location.href);
      return u.searchParams.get(name) ?? defVal;
    }

    // --- State ---
    const state = {
      durationMin: clampInt(parseInt(qs("duration_min","10"),10), 1, 180),
      mode: (qs("mode","timer") || "timer"),
      bg: (qs("bg","off") || "off"),
      vol: clampInt(parseInt(qs("vol","70"),10), 0, 100),
      bell: (qs("bell","1") || "1") !== "0",
      running: false,
      paused: false,
      endAt: 0,
      remainingSec: 0,
    };

    // --- Elements ---
    const $timeLeft = document.getElementById("timeLeft");
    const $status = document.getElementById("status");
    const $durRow = document.getElementById("durRow");
    const $durCustomBtn = document.getElementById("durCustomBtn");
    const $durCustom = document.getElementById("durCustom");

    const $modeRow = document.getElementById("modeRow");
    const $bgRow = document.getElementById("bgRow");
    const $bellToggle = document.getElementById("bellToggle");
    const $testSound = document.getElementById("testSound");

    const $vol = document.getElementById("vol");
    const $volLabel = document.getElementById("volLabel");

    const $startBtn = document.getElementById("startBtn");
    const $pauseBtn = document.getElementById("pauseBtn");
    const $resumeBtn = document.getElementById("resumeBtn");
    const $stopBtn = document.getElementById("stopBtn");

    // --- Helpers ---
    function clampInt(n, lo, hi){ n = Number.isFinite(n) ? n : lo; return Math.max(lo, Math.min(hi, Math.trunc(n))); }
    function fmt(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = String(Math.floor(sec/60)).padStart(2,"0");
      const s = String(sec%60).padStart(2,"0");
      return `${m}:${s}`;
    }
    function vibrate(ms){ try { navigator.vibrate?.(ms); } catch(e) {} }

    // --- WebAudio (single context + master gain) ---
    let audioCtx = null;
    let master = null;
    let bgNode = null; // object with stop()

    function ensureAudio() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return null;
        audioCtx = new AC();
        master = audioCtx.createGain();
        master.gain.value = state.vol / 100;
        master.connect(audioCtx.destination);
      }
      return audioCtx;
    }

    async function unlockAudio() {
      const ctx = ensureAudio();
      if (!ctx) return;
      try { if (ctx.state === "suspended") await ctx.resume(); } catch(e) {}
    }

    function setVolume(v) {
      state.vol = clampInt(v, 0, 100);
      $vol.value = String(state.vol);
      $volLabel.textContent = `${state.vol}%`;
      if (master) master.gain.value = state.vol / 100;
    }

    // Bell (through master)
    function bell(pattern="start") {
      if (!state.bell) return;
      const el = pattern === "start"
        ? document.getElementById("bellStart")
        : document.getElementById("bellEnd");
      if (!el) return;
      el.volume = state.vol / 100;
      el.currentTime = 0;
      el.play().catch(()=>{ try{ _oldBell(pattern); }catch(e){} });
      return;
    }

// legacy fallback
function _oldBell(pattern="start") {
      if (!state.bell) return;
      const ctx = ensureAudio();
      if (!ctx || !master) return;
      const now = ctx.currentTime;

      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(pattern==="start" ? 0.25 : 0.30, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + (pattern==="start" ? 0.35 : 0.75));
      g.connect(master);

      function tone(freq, t0, dur) {
        const o = ctx.createOscillator();
        o.type = "sine";
        o.frequency.setValueAtTime(freq, t0);
        o.connect(g);
        o.start(t0);
        o.stop(t0 + dur);
      }

      if (pattern === "start") {
        tone(880, now + 0.00, 0.35);
        tone(1320, now + 0.05, 0.30);
        vibrate(30);
      } else {
        tone(784,  now + 0.00, 0.60);
        tone(1174, now + 0.06, 0.60);
        tone(1568, now + 0.12, 0.60);
        vibrate([60,40,60]);
      }
    }

    // Background (generated, no mp3)
    function stopBg() {
      try { bgNode?.stop?.(); } catch(e) {}
      bgNode = null;
    }

    function startBg(kind) {
      stopBg();
      if (kind === "off") return;

      const ctx = ensureAudio();
      if (!ctx || !master) return;

      // white noise buffer helper
      function makeNoiseBuffer(seconds=2.0) {
        const sr = ctx.sampleRate;
        const len = Math.floor(sr * seconds);
        const buf = ctx.createBuffer(1, len, sr);
        const data = buf.getChannelData(0);
        for (let i=0;i<len;i++) data[i] = (Math.random()*2 - 1) * 0.35;
        return buf;
      }

      if (kind === "white") {
        const src = ctx.createBufferSource();
        src.buffer = makeNoiseBuffer(2.0);
        src.loop = true;

        const g = ctx.createGain();
        g.gain.value = 0.35; // base level (overall volume still via master)
        src.connect(g).connect(master);
        src.start();
        bgNode = { stop: () => { try{ src.stop(); }catch(e){} } };
        return;
      }

      if (kind === "rain") {
        // noise + lowpass + gentle modulation
        const src = ctx.createBufferSource();
        src.buffer = makeNoiseBuffer(2.0);
        src.loop = true;

        const lp = ctx.createBiquadFilter();
        lp.type = "lowpass";
        lp.frequency.value = 1800;

        const g = ctx.createGain();
        g.gain.value = 0.40;

        src.connect(lp).connect(g).connect(master);
        src.start();

        bgNode = { stop: () => { try{ src.stop(); }catch(e){} } };
        return;
      }

      if (kind === "forest") {
        // ‚Äú–≤–µ—Ç–µ—Ä/–ª–µ—Å‚Äù: pink-ish noise imitation via lowpass + very low rumble
        const src = ctx.createBufferSource();
        src.buffer = makeNoiseBuffer(2.0);
        src.loop = true;

        const lp = ctx.createBiquadFilter();
        lp.type = "lowpass";
        lp.frequency.value = 900;

        const g = ctx.createGain();
        g.gain.value = 0.45;

        // subtle rumble
        const rumble = ctx.createOscillator();
        rumble.type = "sine";
        rumble.frequency.value = 80;

        const rg = ctx.createGain();
        rg.gain.value = 0.05;

        src.connect(lp).connect(g).connect(master);
        rumble.connect(rg).connect(master);

        src.start();
        rumble.start();

        bgNode = { stop: () => { try{ src.stop(); }catch(e){} try{ rumble.stop(); }catch(e){} } };
        return;
      }
    }

    // --- UI render ---
    function setActiveButtons(container, attr, value) {
      [...container.querySelectorAll("button")].forEach(b => {
        const v = b.getAttribute(attr);
        if (v === null) return;
        b.classList.toggle("active", v === value);
      });
    }

    function setRunningUI() {
      $startBtn.disabled = state.running;
      $pauseBtn.disabled = !state.running || state.paused;
      $resumeBtn.disabled = !state.running || !state.paused;
      $stopBtn.disabled = !state.running;

      // lock settings while running
      $durRow.querySelectorAll("button").forEach(b => b.disabled = state.running);
      $durCustom.disabled = state.running;
      $modeRow.querySelectorAll("button").forEach(b => b.disabled = state.running);
      $bgRow.querySelectorAll("button").forEach(b => b.disabled = state.running);
      $bellToggle.disabled = state.running;
      $vol.disabled = false; // –≥—Ä–æ–º–∫–æ—Å—Ç—å –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –Ω–∞ –ª–µ—Ç—É
    }

    function updateHeader() {
      if (!state.running) {
        $timeLeft.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${state.durationMin} –º–∏–Ω`;
        return;
      }
      const left = state.paused ? state.remainingSec : Math.max(0, Math.ceil((state.endAt - Date.now())/1000));
      $timeLeft.textContent = left > 0 ? `–û—Å—Ç–∞–ª–æ—Å—å: ${fmt(left)}` : "‚úÖ –ì–æ—Ç–æ–≤–æ";
    }

    let interval = null;
    function startTicking() {
      stopTicking();
      interval = setInterval(() => {
        if (!state.running) return;
        if (state.paused) return;
        const left = Math.max(0, Math.ceil((state.endAt - Date.now())/1000));
        if (left <= 0) finish();
        updateHeader();
      }, 250);
    }
    function stopTicking() {
      if (interval) clearInterval(interval);
      interval = null;
    }

    function finish() {
      state.running = false;
      state.paused = false;
      stopTicking();
      stopBg();

      $status.innerHTML = '<span class="ok">‚úÖ –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.</span>';
      updateHeader();
      if (state.mode !== "guided") bell("end");

      send("med2_finish", { at: Date.now() });
      setRunningUI();
    }

    // --- Actions ---
    $startBtn.addEventListener("click", async () => {
      await unlockAudio();

      // start bell + bg
      if (state.mode === "timer" || state.mode === "guided") bell("start");
      startBg(state.bg);

      const total = state.durationMin * 60;
      state.running = true;
      state.paused = false;
      state.endAt = Date.now() + total * 1000;
      state.remainingSec = total;

      $status.textContent = "‚è≥ –ò–¥—ë—Ç —Å–µ—Å—Å–∏—è‚Ä¶";
      send("med2_start", {
        duration_s: total,
        duration_min: state.durationMin,
        mode: state.mode,
        bg: state.bg,
        vol: state.vol,
        bell: state.bell ? 1 : 0,
        at: Date.now()
      });

      setRunningUI();
      updateHeader();
      startTicking();
    });

    $pauseBtn.addEventListener("click", () => {
      if (!state.running || state.paused) return;
      state.paused = true;
      state.remainingSec = Math.max(0, Math.ceil((state.endAt - Date.now())/1000));
      stopBg();

      $status.innerHTML = '<span class="warn">‚è∏ –ü–∞—É–∑–∞</span>';
      send("med2_pause", { left_s: state.remainingSec, at: Date.now() });

      setRunningUI();
      updateHeader();
    });

    $resumeBtn.addEventListener("click", async () => {
      if (!state.running || !state.paused) return;
      await unlockAudio();

      state.paused = false;
      state.endAt = Date.now() + (state.remainingSec * 1000);
      startBg(state.bg);

      $status.textContent = "‚è≥ –ò–¥—ë—Ç —Å–µ—Å—Å–∏—è‚Ä¶";
      send("med2_resume", { left_s: state.remainingSec, at: Date.now() });

      setRunningUI();
      updateHeader();
    });

    $stopBtn.addEventListener("click", () => {
      if (!state.running) return;
      state.running = false;
      state.paused = false;
      stopTicking();
      stopBg();

      $status.textContent = "‚èπ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.";
      send("med2_stop", { at: Date.now() });

      setRunningUI();
      updateHeader();
    });

    // --- Controls binding ---
    
$durRow.addEventListener("click", (e) => {
  const b = e.target.closest("button");
  if (!b || state.running) return;

  const min = b.getAttribute("data-min");
  if (min) {
    state.durationMin = clampInt(parseInt(min, 10), 1, 180);

    // –≤—ã–∫–ª—é—á–∞–µ–º –∫–∞—Å—Ç–æ–º-—Ä–µ–∂–∏–º
    $durCustom.style.display = "none";
    $durCustomBtn.classList.remove("active");

    // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    setActiveButtons($durRow, "data-min", String(state.durationMin));

    updateHeader();
    return;
  }

  // –µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ "–ö–∞—Å—Ç–æ–º"
  if (b === $durCustomBtn) {
    $durCustom.style.display = ($durCustom.style.display === "none" ? "block" : "none");
    $durCustom.value = String(state.durationMin);
    $durCustomBtn.classList.add("active");

    // —Å–Ω–∏–º–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å –ø—Ä–µ—Å–µ—Ç–æ–≤, —Ç.–∫. –º—ã –≤ –∫–∞—Å—Ç–æ–º–µ
    setActiveButtons($durRow, "data-min", "__none__");

    updateHeader();
  }
});

// –∫–∞—Å—Ç–æ–º–Ω–æ–µ –ø–æ–ª–µ: –æ–±–Ω–æ–≤–ª—è–µ–º duration + –ø–æ–¥—Å–≤–µ—Ç–∫—É
$durCustom.addEventListener("change", () => {
  if (state.running) return;
  state.durationMin = clampInt(parseInt($durCustom.value || "10", 10), 1, 180);
  $durCustomBtn.classList.add("active");
  updateHeader();
});


    // --- init from state ---
    setVolume(state.vol);

    $vol.addEventListener("input", () => setVolume(parseInt($vol.value, 10)));


$durCustomBtn.classList.remove("active");
$durCustom.style.display = "none";
setActiveButtons($durRow, "data-min", String(state.durationMin));
    setActiveButtons($modeRow, "data-mode", state.mode);
    setActiveButtons($bgRow, "data-bg", state.bg);
    $bellToggle.textContent = state.bell ? "On" : "Off";
    $durCustom.value = String(state.durationMin);
    updateHeader();
    setRunningUI();

  })();
  </script>
</body>
</html>