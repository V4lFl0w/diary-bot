<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Premium</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #071018;
      --panel: rgba(255,255,255,.06);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --brand: #2dd4bf;
      --brand2: #ec4899;
      --brand3: #a855f7;

      --success: #22c55e;
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.16);

      --radius2: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 520px at 20% -10%, rgba(45,212,191,.28), transparent 55%),
        radial-gradient(900px 420px at 90% 10%, rgba(236,72,153,.18), transparent 55%),
        radial-gradient(900px 520px at 70% 110%, rgba(168,85,247,.16), transparent 55%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      padding: calc(14px + env(safe-area-inset-top)) 14px calc(18px + env(safe-area-inset-bottom));
    }

    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:10px;}
    .title{font-size:18px;font-weight:800;margin:0;line-height:1.2;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35;}

    .pill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius:999px;
      display:flex;align-items:center;gap:8px;
      color:var(--muted);font-size:12px;white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--brand);
      box-shadow: 0 0 0 4px rgba(45,212,191,.18);
    }

    .tabs{
      display:flex;gap:6px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:6px;
      margin: 14px 0 14px;
    }
    .tab{
      flex:1;border:0;background:transparent;
      color: var(--muted);
      padding:11px 10px;border-radius:999px;
      font-weight:800;font-size:14px;cursor:pointer;
    }
    .tab.active{
      background: rgba(45,212,191,.18);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(45,212,191,.30);
    }

    .screen{display:none}
    .screen.active{display:block}

    .carousel{
      display:flex;gap:12px;overflow:auto;padding-bottom:6px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .carousel::-webkit-scrollbar{display:none}

    .card{
      min-width: 86%;
      scroll-snap-align: start;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius2);
      padding:14px;
      position:relative;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    
.card.selected{
  border-color: rgba(45,212,191,.45);
  box-shadow: 0 8px 20px rgba(0,0,0,.25);
  background: rgba(255,255,255,.06);
}

    .badge{
      position:absolute;top:12px;right:12px;
      background: rgba(236,72,153,.18);
      border:1px solid rgba(236,72,153,.30);
      color: var(--text);
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
    }

    .cardHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:12px;}
    .planName{font-size:22px;font-weight:950;margin:0;letter-spacing:.2px;}
    .planDesc{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35;}

    .check{
      width:28px;height:28px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      flex: 0 0 auto;
    }
    .card.selected .check{
      border-color: rgba(45,212,191,.75);
      background: rgba(45,212,191,.18);
    }

    .priceRow{display:flex;align-items:baseline;gap:8px;margin: 10px 0 12px;}
    .price{font-size:46px;font-weight:950;letter-spacing:-.8px;}
    .per{color:var(--muted);font-size:14px;font-weight:800;}
    .smallLine{color:var(--muted);font-size:13px;margin-top:-6px;line-height:1.35;}
    .smallLine strong{color:rgba(255,255,255,.90);font-weight:900}

    
.gift{
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.06);
  padding:12px;
  border-radius:12px;
  margin:12px 0 6px;
}
.giftTop{
  display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;
}
.giftText{font-weight:950;}
.giftMeta{color:var(--muted);font-size:13px;line-height:1.35;}
    .giftText{font-weight:900;}

    .list{margin:10px 0 0;padding:0;list-style:none;display:grid;gap:10px;}
    .li{display:flex;align-items:flex-start;gap:10px;color: rgba(255,255,255,.88);font-size:14px;line-height:1.35;}
    .tick{
      width:18px;height:18px;border-radius:6px;
      background: rgba(34,197,94,.15);
      border:1px solid rgba(34,197,94,.30);
      display:grid;place-items:center;
      color: var(--success);
      margin-top:1px;flex: 0 0 auto;
    }

    .footer{margin-top: 16px; border:1px solid var(--stroke); padding:14px; background: rgba(255,255,255,.04); border-radius: var(--radius2); }
    .payMethod{color:var(--muted);font-size:13px;margin: 0 0 10px;}

    .btn{
      width:100%;
      border:0;cursor:pointer;
      border-radius: 16px;
      padding: 16px 14px;
      font-weight:950;font-size:16px;
      color: white;
      background: linear-gradient(90deg, var(--brand), var(--brand2), var(--brand3));
      box-shadow: 0 10px 24px rgba(45,212,191,.18);
    }
    .btn:active{ transform: translateY(1px); }

    /* pay method pills */
    .payTabs{
      display:flex;gap:8px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:6px;
      margin: 10px 0 12px;
    }
    .payTab{
      flex:1;border:0;background:transparent;
      color: var(--muted);
      padding:10px 10px;border-radius:999px;
      font-weight:900;font-size:13px;cursor:pointer;
    }
    .payTab.active{
      background: rgba(45,212,191,.18);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(45,212,191,.30);
    }
    .payTab[disabled]{
      opacity:.45;
      cursor:not-allowed;
    }

    /* Tokens screen */
    .tokenBox{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius2);
      padding:14px;
    }
    .tokenTitle{font-size:18px;font-weight:950;margin:0 0 6px;}
    .tokenGrid{display:grid;gap:10px;margin-top:12px;}
    .tokenItem{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.045);
      border-radius: 16px;
      padding:12px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .tokenItem strong{font-size:14px}
    .tokenItem span{color:var(--muted);font-size:13px}
  
    @keyframes vfPop {
      from { transform: translateY(10px); opacity: 0; }
      to   { transform: translateY(0); opacity: 1; }
    }
    @keyframes vfGlow {
      0%   { filter: brightness(1); transform: translateY(0); }
      50%  { filter: brightness(1.08); transform: translateY(-1px); }
      100% { filter: brightness(1); transform: translateY(0); }
    }

    .vf-pop { animation: vfPop .28s ease-out both; }
    .vf-delay-1 { animation-delay: .02s; }
    .vf-delay-2 { animation-delay: .06s; }
    .vf-delay-3 { animation-delay: .10s; }

    .btn.vf-glow { animation: vfGlow 1.6s ease-in-out infinite; }

  
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

.presale-line {
  opacity: 0;
  animation: fadeUp .4s ease forwards;
}

.presale-line:nth-child(1){ animation-delay:.05s }
.presale-line:nth-child(2){ animation-delay:.1s }
.presale-line:nth-child(3){ animation-delay:.15s }
.presale-line:nth-child(4){ animation-delay:.2s }
.presale-line:nth-child(5){ animation-delay:.25s }
.presale-line:nth-child(6){ animation-delay:.3s }

@keyframes planGlow {
  0%   { box-shadow: 0 0 0 rgba(0,255,180,0); }
  50%  { box-shadow: 0 0 18px rgba(0,255,180,0.35); }
  100% { box-shadow: 0 0 0 rgba(0,255,180,0); }
}

.card.selected {
  animation: planGlow 2.4s ease-in-out infinite;
  border-color: rgba(0,255,180,.6) !important;
}

    /* VF_PAY_UI_V4 */
    .payDivider{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 10px 2px 12px;
      border-radius: 999px;
    }

    /* periods stay as pill; payment methods become separate row */
    #payTabsSub{
      background: transparent;
      border: 0;
      padding: 0;
      margin: 0;
      display:flex;
      gap:10px;
    }
    #payTabsSub .payTab{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 6px 14px rgba(0,0,0,.18);
    }
    #payTabsSub .payTab.active{
      background: rgba(45,212,191,.14);
      border-color: rgba(45,212,191,.28);
      box-shadow: 0 6px 14px rgba(0,0,0,.18), inset 0 0 0 1px rgba(45,212,191,.18);
    }

    /* make the footer feel less like one big slab */
    .footer{
      background: rgba(255,255,255,.035);
    }

  
    /* VF_PLAN_GLOW_V1 */
    .card{
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease, transform .18s ease;
    }
    .card.selected{
      border-color: rgba(45,212,191,.55);
      background: rgba(255,255,255,.06);
      box-shadow:
        0 10px 26px rgba(0,0,0,.28),
        0 0 0 1px rgba(45,212,191,.22) inset,
        0 0 22px rgba(45,212,191,.16);
      transform: translateY(-1px);
    }
/* VF_PERIOD_ROW_V1 */
    #periodTabsSub{
      background: transparent !important;
      border: 0 !important;
      padding: 0 !important;
      margin: 0 0 6px 0 !important;
      display:flex;
      gap:10px;
    }
    #periodTabsSub .payTab{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 6px 14px rgba(0,0,0,.18);
    }
    #periodTabsSub .payTab.active{
      background: rgba(45,212,191,.14);
      border-color: rgba(45,212,191,.28);
      box-shadow: 0 6px 14px rgba(0,0,0,.18), inset 0 0 0 1px rgba(45,212,191,.18);
    }


/* VF_FOOTER_GLASS_V2 */
/* hide any payment hint text placeholders */
#payHint, #payHintTok { display:none !important; }

/* single source of truth: glass footer */
.footer.vfGlassFooter{
  background: rgba(15,18,25,0.55) !important;
  border: 1px solid rgba(255,255,255,0.10) !important;
  box-shadow: 0 -10px 30px rgba(0,0,0,0.18) !important;
  -webkit-backdrop-filter: blur(14px) !important;
  backdrop-filter: blur(14px) !important;
}



/* VF_APPLE_MICRO_POLISH_V1 */
body{
  text-rendering: optimizeLegibility;
  -webkit-text-size-adjust: 100%;
}
.title{ letter-spacing:-0.2px }
.planName{ letter-spacing:-0.3px }
.price{ letter-spacing:-1.1px }

.btn,.tab,.payTab,.card,.tokenItem{
  -webkit-tap-highlight-color: transparent;
}
.btn:active{ transform:translateY(1px) scale(.99) }
.tab:active,.payTab:active{ transform:scale(.99) }
.card:active{ transform:translateY(0) scale(.995) }

.tab:focus-visible,.payTab:focus-visible,.btn:focus-visible{
  outline:none;
  box-shadow:0 0 0 3px rgba(45,212,191,.18),0 0 0 1px rgba(255,255,255,.10) inset;
}

@media (prefers-reduced-motion:reduce){
  *{animation:none!important;transition:none!important}
}

.carousel{
  scroll-behavior:smooth;
  scroll-padding-left:14px;
  overscroll-behavior-x:contain;
}

.tokenItem{
  transition:transform .14s ease,box-shadow .18s ease,border-color .18s ease;
}
.tokenItem:active{ transform:scale(.995) }


</style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1 class="title">–ü—Ä–µ–º–∏—É–º</h1>
      <p class="subtitle">–í—ã–±–µ—Ä–∏ –ø–æ–¥–ø–∏—Å–∫—É (–ë–µ–π—Å–∏–∫/–ü—Ä–æ/–ú–∞–∫—Å) –∏–ª–∏ —Ç–æ–∫–µ–Ω—ã –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –∑–∞–¥–∞—á.</p>
    </div>
    <div class="pill" id="userPill">
      <span class="dot"></span>
      <span id="userText">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
    </div>
  </div>

  <div class="tabs" role="tablist">
    <button class="tab active" data-tab="sub">–ü–æ–¥–ø–∏—Å–∫–∞</button>
    <button class="tab" data-tab="tok">–¢–æ–∫–µ–Ω—ã</button>
  </div>

  <section class="screen active" id="screen-sub">
    <div class="carousel" id="plans"></div>

    <div class="footer vfGlassFooter">
      <p class="payMethod" id="payHint"></p>

      <div class="payTabs" id="periodTabsSub">
        <button class="payTab active" data-period="month">–ú–µ—Å—è—Ü</button>
        <button class="payTab" data-period="quarter">–ö–≤–∞—Ä—Ç–∞–ª ‚àí10%</button>
        <button class="payTab" data-period="year">–ì–æ–¥ ‚àí25%</button>
      </div>

<div class="payDivider"></div>

<div class="payTabs" id="payTabsSub">
        <button class="payTab active" data-method="card">üí≥ –ö–∞—Ä—Ç–∞</button>
        <button class="payTab" data-method="stars">‚≠ê Stars</button>
        <button class="payTab" data-method="crypto">ü™ô –ö—Ä–∏–ø—Ç–∞</button>
      </div>

      <button class="btn" id="payBtn">–û–ø–ª–∞—Ç–∏—Ç—å</button>
    </div>
  </section>

  <section class="screen" id="screen-tok">
    <div class="tokenBox">
      <h2 class="tokenTitle">–ü–∞–∫–µ—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤</h2>
      <div class="subtitle" style="margin:0;">–¢–æ–∫–µ–Ω—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∑–∞ —Ç—è–∂—ë–ª—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–≤–∏–¥–µ–æ/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/–¥–æ—Ä–æ–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã).</div>

      <div class="tokenGrid" id="tokenPacks"></div>

      <div class="footer vfGlassFooter">
        <div class="payTabs" id="payTabsTok">
          <button class="payTab active" data-method="card">üí≥ –ö–∞—Ä—Ç–∞</button>
          <button class="payTab" data-method="crypto" disabled>ü™ô –ö—Ä–∏–ø—Ç–∞</button>
        </div>

        <button class="btn" id="buyTokensBtn">–ö—É–ø–∏—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
      </div>
    </div>
  </section>

    <script>
    const tg = window.Telegram?.WebApp || null;

    function tgPopup(msg){
      try { tg?.showPopup?.({ message: String(msg) }); } catch(e) {}
    }

    // VF_HAPTIC_V1
    function haptic(kind="light"){
      try { tg?.HapticFeedback?.impactOccurred?.(kind); } catch(e) {}
    }

    function tgPopup(msg){
      try { tg?.showPopup?.({ message: String(msg) }); } catch(e) {}
    }

    // --- language detect (ru/uk/en) ---
    let LANG = "ru";
    let forcedLang = null;
    let tgUserId = null;

    // --- allow forcing lang via query (?lang=ru|uk|en) to avoid Telegram language_code mismatch
    try {
      const qs = new URLSearchParams(window.location.search || "");
      const forced = String(qs.get("lang") || qs.get("locale") || "").toLowerCase();
      if (forced) {
        forcedLang = forced.startsWith("uk") ? "uk" : (forced.startsWith("en") ? "en" : "ru");
        LANG = forcedLang;
      }
    } catch (e) {}
    if (tg) {
      try { tg.ready(); } catch(e) {}
      try { tg.expand(); } catch(e) {}

      const u = tg.initDataUnsafe?.user;
      if (u) {
        tgUserId = u.id || null;
        const lc = String(u.language_code || "ru").toLowerCase();
        if (!forcedLang) {
          LANG = lc.startsWith("uk") ? "uk" : (lc.startsWith("en") ? "en" : "ru");
        }

        document.getElementById("userText").textContent =
          `${u.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"}${u.username ? " @" + u.username : ""}`;
      }
    } else {
      const lc = String(navigator.language || "ru").toLowerCase();
      if (!forcedLang) {
        LANG = lc.startsWith("uk") ? "uk" : (lc.startsWith("en") ? "en" : "ru");
      }
    }

    const I18N = {
      ru: {
        title: "–ü—Ä–µ–º–∏—É–º",
        subtitle: "–í—ã–±–µ—Ä–∏ –ø–æ–¥–ø–∏—Å–∫—É (–ë–µ–π—Å–∏–∫/–ü—Ä–æ/–ú–∞–∫—Å) –∏–ª–∏ —Ç–æ–∫–µ–Ω—ã –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –∑–∞–¥–∞—á.",
        tab_sub: "–ü–æ–¥–ø–∏—Å–∫–∞",
        tab_tok: "–¢–æ–∫–µ–Ω—ã",
        period_m: "–ú–µ—Å—è—Ü",
        period_q: "–ö–≤–∞—Ä—Ç–∞–ª ‚àí10%",
        period_y: "–ì–æ–¥ ‚àí25%",
        bonus_for_heavy: "–ë–æ–Ω—É—Å-—Ç–æ–∫–µ–Ω—ã –Ω–∞ —Ç—è–∂—ë–ª—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏",
        pay_card: "üí≥ –ö–∞—Ä—Ç–∞",
        pay_stars: "‚≠ê Stars",
        pay_crypto: "ü™ô –ö—Ä–∏–ø—Ç–∞",
pay_hint_basic_crypto_off: "–ö—Ä–∏–ø—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è Pro/Max (–º–∏–Ω–∏–º–∞–ª–∫–∞ $10).",
btn_pay: "–û–ø–ª–∞—Ç–∏—Ç—å",
        btn_buy: "–ö—É–ø–∏—Ç—å",
        tokens_title: "–ü–∞–∫–µ—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤",
        tokens_sub: "–¢–æ–∫–µ–Ω—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∑–∞ —Ç—è–∂—ë–ª—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–≤–∏–¥–µ–æ/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/–¥–æ—Ä–æ–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã).",
        chosen: "–≤—ã–±—Ä–∞–Ω–æ",
        choose: "–≤—ã–±—Ä–∞—Ç—å",
        gift_prefix: "+",
        gift_suffix: " —Ç–æ–∫–µ–Ω–æ–≤",
        stars_line: "–∏–ª–∏ ",
        stars_suffix: "‚≠ê —á–µ—Ä–µ–∑ Stars",
      },
      uk: {
        title: "–ü—Ä–µ–º—ñ—É–º",
        subtitle: "–û–±–µ—Ä–∏ –ø—ñ–¥–ø–∏—Å–∫—É (–ë–µ–π—Å–∏–∫/–ü—Ä–æ/–ú–∞–∫—Å) –∞–±–æ —Ç–æ–∫–µ–Ω–∏ –¥–ª—è –≤–∞–∂–∫–∏—Ö –∑–∞–¥–∞—á.",
        tab_sub: "–ü—ñ–¥–ø–∏—Å–∫–∞",
        tab_tok: "–¢–æ–∫–µ–Ω–∏",
        period_m: "–ú—ñ—Å—è—Ü—å",
        period_q: "–ö–≤–∞—Ä—Ç–∞–ª ‚àí10%",
        period_y: "–†—ñ–∫ ‚àí25%",
        bonus_for_heavy: "–ë–æ–Ω—É—Å-—Ç–æ–∫–µ–Ω–∏ –Ω–∞ –≤–∞–∂–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó",
        pay_card: "üí≥ –ö–∞—Ä—Ç–∫–∞",
        pay_stars: "‚≠ê Stars",
        pay_crypto: "ü™ô –ö—Ä–∏–ø—Ç–∞",
pay_hint_basic_crypto_off: "–ö—Ä–∏–ø—Ç–∞ –ª–∏—à–µ –¥–ª—è Pro/Max (–º—ñ–Ω—ñ–º—É–º $10).",
btn_pay: "–û–ø–ª–∞—Ç–∏—Ç–∏",
        btn_buy: "–ö—É–ø–∏—Ç–∏",
        tokens_title: "–ü–∞–∫–µ—Ç–∏ —Ç–æ–∫–µ–Ω—ñ–≤",
        tokens_sub: "–¢–æ–∫–µ–Ω–∏ —Å–ø–∏—Å—É—é—Ç—å—Å—è –∑–∞ –≤–∞–∂–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (–≤—ñ–¥–µ–æ/–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è/–¥–æ—Ä–æ–≥—ñ –∑–∞–ø–∏—Ç–∏).",
        chosen: "–æ–±—Ä–∞–Ω–æ",
        choose: "–æ–±—Ä–∞—Ç–∏",
        gift_prefix: "+",
        gift_suffix: " —Ç–æ–∫–µ–Ω—ñ–≤",
        stars_line: "–∞–±–æ ",
        stars_suffix: "‚≠ê —á–µ—Ä–µ–∑ Stars",
      },
      en: {
        title: "Premium",
        subtitle: "Choose a plan (Basic/Pro/Max) or tokens for heavy tasks.",
        tab_sub: "Subscription",
        tab_tok: "Tokens",
        period_m: "Month",
        period_q: "Quarter ‚àí10%",
        period_y: "Year ‚àí25%",
        bonus_for_heavy: "Bonus tokens for heavy features",
        pay_card: "üí≥ Card",
        pay_stars: "‚≠ê Stars",
        pay_crypto: "ü™ô Crypto",
pay_hint_basic_crypto_off: "Crypto is Pro/Max only (min $10).",
btn_pay: "Pay",
        btn_buy: "Buy",
        tokens_title: "Token packs",
        tokens_sub: "Tokens are used for heavy features (video/images/expensive requests).",
        chosen: "selected",
        choose: "select",
        gift_prefix: "+",
        gift_suffix: " tokens",
        stars_line: "or ",
        stars_suffix: "‚≠ê via Stars",
      }
    };

    const t = I18N[LANG] || I18N.ru;

    // apply static texts
    document.querySelector(".title").textContent = t.title;
    document.querySelector(".subtitle").textContent = t.subtitle;
    document.querySelector('.tab[data-tab="sub"]').textContent = t.tab_sub;
    document.querySelector('.tab[data-tab="tok"]').textContent = t.tab_tok;
    document.querySelector(".tokenTitle").textContent = t.tokens_title;
    document.querySelector("#screen-tok .subtitle").textContent = t.tokens_sub;

    // periods (month/quarter/year)
    const PERIODS = {
      month:   { months: 1,  discount: 1.00 },
      quarter: { months: 3,  discount: 0.90 },
      year:    { months: 12, discount: 0.75 },
    };
    let selectedPeriod = "month";

    // Stars base per MONTH (edit these to your economics)
    const STARS_BASE = {
      basic: 199,
      pro:   449,
      max:   999,
    };

    // Bonus tokens base per MONTH (real numbers, Apple-style)
    // Explain: tokens are used for heavy features (images/video/expensive requests)
    const BONUS_TOKENS_BASE = {
      basic: 60,
      pro:   180,
      max:   450,
    };

    const CURRENCY = "UAH";
    function money(n){ return `${n}‚Ç¥`; }

    // --- crypto UX: show approximate USD (not exact rate)
    const FX_USD = 40; // ~UAH per $ (approx for UI only)
    const USD_MIN = 10;
    function calcUsdApprox(uah){
      try { return Math.max(USD_MIN, Math.round(Number(uah || 0) / FX_USD)); } catch(e){ return USD_MIN; }
    }
    function primaryAmountForPlan(plan){
      const priceUah = calcPriceUah(plan);
      const stars = calcStars(plan.id);
      const usd = calcUsdApprox(priceUah);
      if (payMethodSub === "stars") return `${stars}‚≠ê`;
      if (payMethodSub === "crypto") return `~$${usd}`;
      return money(priceUah);
    }
    // --- Stars ---
    async function payByStars(planId, starsAmount, title, description) {
      if (!tg || typeof tg.openInvoice !== "function") {
        tgPopup("openInvoice –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π WebApp –≤–Ω—É—Ç—Ä–∏ Telegram.");
        return false;
      }
      try {
        const payload = `stars:buy:webapp:${planId}:${selectedPeriod}:${Date.now()}`;
        const resp = await fetch("/api/stars/invoice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            stars: Number(starsAmount || 0),
            payload,
            title: title || "Premium",
            description: description || `Premium (${planId}, ${selectedPeriod}) —á–µ—Ä–µ–∑ Stars`,
          }),
        });

        let out = null;
        try { out = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          tgPopup("Stars API error: " + (out?.detail || resp.status));
          return false;
        }

        const link = out?.invoice_link;
        if (!link) {
          tgPopup("invoice_link –Ω–µ –ø–æ–ª—É—á–µ–Ω");
          return false;
        }

        tg.openInvoice(link, (status) => {
          console.log("Stars invoice status:", status);
          tgPopup("–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: " + status);
        });

        return true;
      } catch (e) {
        tgPopup("Stars error: " + String(e));
        return false;
      }
    }

    // --- Monobank (card) ---
    async function payByMono(kind, amountUah, title, description) {
      if (!tg) {
        alert("DEV MODE: tg is missing");
        return false;
      }
      if (!tgUserId) {
        tgPopup("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å user id Telegram");
        return false;
      }

      try {
        const resp = await fetch("/api/mono/invoice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            tg_id: Number(tgUserId),
            kind: String(kind || "unknown"),
            amount_uah: Number(amountUah || 0),
            title: title || "DiaryBot Premium",
            description: description || "–û–ø–ª–∞—Ç–∞ Premium",
          }),
        });

        let out = null;
        try { out = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          tgPopup("Mono API error: " + (out?.detail || resp.status));
          return false;
        }

        const url = out?.invoice_url;
        if (!url) {
          tgPopup("invoice_url –Ω–µ –ø–æ–ª—É—á–µ–Ω");
          return false;
        }

        if (typeof tg.openLink === "function") tg.openLink(url);
        else window.open(url, "_blank");

        return true;
      } catch (e) {
        tgPopup("Mono error: " + String(e));
        return false;
      }
    }

    // --- Bot bridge (for crypto now / later) ---
    function sendToBot(payload) {
      const data = JSON.stringify(payload);
      if (tg) tg.sendData(data);
      else {
        console.log("WebApp payload:", payload);
        alert("DEV MODE:\n" + data);
      }
    }

    // Plans (Apple-style bullets + real bonus tokens)
    const PLANS = [
      {
        id: "basic",
        tag: (LANG==="en" ? "‚≠ê Best start" : (LANG==="uk" ? "‚≠ê –ù–∞–π–∫—Ä–∞—â–∏–π —Å—Ç–∞—Ä—Ç" : "‚≠ê –õ—É—á—à–∏–π —Å—Ç–∞—Ä—Ç")),
        name: (LANG==="en" ? "Basic" : (LANG==="uk" ? "–ë–µ–π—Å–∏–∫" : "–ë–µ–π—Å–∏–∫")),
        desc: (LANG==="en" ? "Daily comfort: core features + stable usage." :
              (LANG==="uk" ? "–ö–æ–º—Ñ–æ—Ä—Ç —â–æ–¥–Ω—è: –æ—Å–Ω–æ–≤–Ω—ñ —Ñ—ñ—á—ñ + —Å—Ç–∞–±—ñ–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞." :
                             "–ö–æ–º—Ñ–æ—Ä—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å: –±–∞–∑–æ–≤—ã–µ —Ñ–∏—á–∏ + —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞.")),
        price_uah: 199,
        per: "",
        under_price: (LANG==="en" ? "Core features & smooth flow" :
                     (LANG==="uk" ? "–û—Å–Ω–æ–≤–Ω—ñ —Ñ—ñ—á—ñ –π —Å–ø–æ–∫—ñ–π–Ω–∏–π —Ä–µ–∂–∏–º" :
                                    "–ö–ª—é—á–µ–≤—ã–µ —Ñ–∏—á–∏ –∏ —Å–ø–æ–∫–æ–π–Ω—ã–π —Ä–µ–∂–∏–º")),
        bullets: (LANG==="en" ? [
          "Everything needed for daily use",
          "Stable performance & clear limits",
          "Bonus tokens for heavy features",
        ] : (LANG==="uk" ? [
          "–£—Å–µ –ø–æ—Ç—Ä—ñ–±–Ω–µ –¥–ª—è —â–æ–¥–µ–Ω–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è",
          "–°—Ç–∞–±—ñ–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ —Ç–∞ –∑—Ä–æ–∑—É–º—ñ–ª—ñ –ª—ñ–º—ñ—Ç–∏",
          "–ë–æ–Ω—É—Å-—Ç–æ–∫–µ–Ω–∏ –Ω–∞ –≤–∞–∂–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó",
        ] : [
          "–î–Ω–µ–≤–Ω–∏–∫ + –∑–∞–º–µ—Ç–∫–∏ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —à—É–º–∞",
          "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ —Ä–µ–∂–∏–º –¥–Ω—è (–±—ã—Å—Ç—Ä–æ)",
          "–ë–æ–Ω—É—Å-—Ç–æ–∫–µ–Ω—ã –Ω–∞ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/–¥–æ–∫—É–º–µ–Ω—Ç—ã",
        ])),
      },
      {
        id: "pro",
        tag: (LANG==="en" ? "üî• Active mode" : (LANG==="uk" ? "üî• –î–ª—è –∞–∫—Ç–∏–≤–Ω–æ—ó —Ä–æ–±–æ—Ç–∏" : "üî• –î–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã")),
        name: (LANG==="en" ? "Pro" : "–ü—Ä–æ"),
        desc: (LANG==="en" ? "More power: work & creativity." :
              (LANG==="uk" ? "–ë—ñ–ª—å—à–µ –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ: –¥–ª—è —Ä–æ–±–æ—Ç–∏ —Ç–∞ –∫—Ä–µ–∞—Ç–∏–≤—É." :
                             "–ë–æ–ª—å—à–µ –º–æ—â–Ω–æ—Å—Ç–∏: –¥–ª—è —Ä–∞–±–æ—Ç—ã –∏ –∫—Ä–µ–∞—Ç–∏–≤–∞.")),
        price_uah: 499,
        per: "",
        under_price: (LANG==="en" ? "More actions, less friction" :
                     (LANG==="uk" ? "–ë—ñ–ª—å—à–µ –¥—ñ–π, –º–µ–Ω—à–µ –æ–±–º–µ–∂–µ–Ω—å" :
                                    "–ë–æ–ª—å—à–µ –¥–µ–π—Å—Ç–≤–∏–π, –º–µ–Ω—å—à–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π")),
        bullets: (LANG==="en" ? [
          "Comfortable usage without pauses",
          "Extra bonus tokens for heavy tasks",
          "Best value for daily intensity",
        ] : (LANG==="uk" ? [
          "–ö–æ–º—Ñ–æ—Ä—Ç–Ω–∏–π —Ä–µ–∂–∏–º –±–µ–∑ –ø–∞—É–∑",
          "–ë—ñ–ª—å—à–µ –±–æ–Ω—É—Å-—Ç–æ–∫–µ–Ω—ñ–≤ –Ω–∞ –≤–∞–∂–∫—ñ –∑–∞–¥–∞—á—ñ",
          "–ù–∞–π–∫—Ä–∞—â–µ —Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è —Ü—ñ–Ω–∞/–∫–æ—Ä–∏—Å—Ç—å",
        ] : [
          "–í—ã—à–µ –ª–∏–º–∏—Ç—ã –∏ —Å–∫–æ—Ä–æ—Å—Ç—å, –º–µ–Ω—å—à–µ –æ–∂–∏–¥–∞–Ω–∏—è",
          "–§–æ—Ç–æ-–∫–∞–ª–æ—Ä–∏–∏ + —Ä–∞–±–æ—Ç–∞ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏",
          "–õ—É—á—à–∏–π —Ç–∞—Ä–∏—Ñ –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏",
        ])),
      },
      {
        id: "max",
        tag: (LANG==="en" ? "üöÄ Maximum" : (LANG==="uk" ? "üöÄ –ú–∞–∫—Å–∏–º—É–º" : "üöÄ –ú–∞–∫—Å–∏–º—É–º")),
        name: (LANG==="en" ? "Max" : "–ú–∞–∫—Å"),
        desc: (LANG==="en" ? "Maximum freedom: for heavy daily use." :
              (LANG==="uk" ? "–ú–∞–∫—Å–∏–º—É–º —Å–≤–æ–±–æ–¥–∏: –¥–ª—è —â–æ–¥–µ–Ω–Ω–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è." :
                             "–ú–∞–∫—Å–∏–º—É–º —Å–≤–æ–±–æ–¥—ã: –ø–æ–¥ –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É.")),
        price_uah: 999,
        per: "",
        under_price: (LANG==="en" ? "Maximum comfort & capacity" :
                     (LANG==="uk" ? "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π –∫–æ–º—Ñ–æ—Ä—Ç —ñ –º—ñ—Å—Ç–∫—ñ—Å—Ç—å" :
                                    "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫–æ–º—Ñ–æ—Ä—Ç –∏ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å")),
        bullets: (LANG==="en" ? [
          "Maximum limits and smooth usage",
          "Maximum bonus tokens included",
          "For creators, teams and power users",
        ] : (LANG==="uk" ? [
          "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ñ –ª—ñ–º—ñ—Ç–∏ —Ç–∞ –ø–ª–∞–≤–Ω–∞ —Ä–æ–±–æ—Ç–∞",
          "–ú–∞–∫—Å–∏–º—É–º –±–æ–Ω—É—Å-—Ç–æ–∫–µ–Ω—ñ–≤ —É –∫–æ–º–ø–ª–µ–∫—Ç—ñ",
          "–î–ª—è –∫—Ä–µ–∞—Ç–æ—Ä—ñ–≤ —ñ ¬´power users¬ª",
        ] : [
          "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã –±–µ–∑ –ø–∞—É–∑",
          "–ú–∞–∫—Å–∏–º—É–º –±–æ–Ω—É—Å-—Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Ç—è–∂—ë–ª—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏",
          "–î–ª—è —Ç–µ—Ö, –∫—Ç–æ –ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å",
        ])),
      },
    ];
const TOKEN_PACKS = [
      { id: "t100", name: {ru:"100 —Ç–æ–∫–µ–Ω–æ–≤", uk:"100 —Ç–æ–∫–µ–Ω—ñ–≤", en:"100 tokens"}, price_uah: 199, note: {ru:"–¢–æ—á–µ—á–Ω–æ", uk:"–¢–æ—á–∫–æ–≤–æ", en:"Occasional"} },
      { id: "t300", name: {ru:"300 —Ç–æ–∫–µ–Ω–æ–≤", uk:"300 —Ç–æ–∫–µ–Ω—ñ–≤", en:"300 tokens"}, price_uah: 499, note: {ru:"–û–ø—Ç–∏–º–∞–ª—å–Ω–æ", uk:"–û–ø—Ç–∏–º–∞–ª—å–Ω–æ", en:"Best value"} },
      { id: "t800", name: {ru:"800 —Ç–æ–∫–µ–Ω–æ–≤", uk:"800 —Ç–æ–∫–µ–Ω—ñ–≤", en:"800 tokens"}, price_uah: 1099, note:{ru:"–ê–∫—Ç–∏–≤–Ω–æ", uk:"–ê–∫—Ç–∏–≤–Ω–æ", en:"Heavy use"} },
    ];

    let selectedMode = "subscription";
    let selectedPlanId = "basic";
    let selectedTokenPackId = "t300";

    let payMethodSub = "card";   // card | stars | crypto
    let payMethodTok = "card";   // card | crypto

    // --- render helpers ---
    function calcPriceUah(plan){
      const per = PERIODS[selectedPeriod];
      return Math.round(plan.price_uah * per.months * per.discount);
    }
    function calcStars(planId){
      const per = PERIODS[selectedPeriod];
      return Math.round((STARS_BASE[planId] || 0) * per.months * per.discount);
    }
    function calcBonusTokens(planId){
      const per = PERIODS[selectedPeriod];
      return Math.round((BONUS_TOKENS_BASE[planId] || 0) * per.months * per.discount);
    }

    const plansEl = document.getElementById("plans");
    function renderPlans() {
      plansEl.innerHTML = "";
      for (const plan of PLANS) {
        const card = document.createElement("div");
        card.className = "card" + (plan.id === selectedPlanId ? " selected" : "") + " vf-pop " +
  (plan.id==="basic" ? "vf-delay-1" : (plan.id==="pro" ? "vf-delay-2" : "vf-delay-3"));

        card.dataset.plan = plan.id;

        const price = calcPriceUah(plan);
        const stars = calcStars(plan.id);
        const bonus = calcBonusTokens(plan.id);

        const starsLine = "";

        const giftLine = `<div class="giftText">${t.gift_prefix}${bonus}${t.gift_suffix}</div>`;

        card.innerHTML = `
          ${plan.tag ? `<div class="badge">${plan.tag}</div>` : ""}
          <div class="cardHeader">
            <div>
              <h3 class="planName">${plan.name}</h3>
              <p class="planDesc">${plan.desc}</p>
            </div>
            <div class="check" aria-label="selected">${plan.id === selectedPlanId ? "‚úì" : ""}</div>
          </div>

          <div class="priceRow">
            <div class="price">${primaryAmountForPlan(plan)}</div>
            <div class="per">/ ${selectedPeriod === "month" ? t.period_m : (selectedPeriod==="quarter" ? t.period_q : t.period_y)}</div>
          </div>

          <div class="smallLine"><strong>${plan.under_price || ""}</strong></div>
          ${starsLine}

          <div class="gift">
            <div class="giftTop">
              ${giftLine}
              <span class="giftMeta">${t.bonus_for_heavy}</span>
            </div>
          </div>

          <ul class="list">
            ${plan.bullets.map(x => `
              <li class="li"><span class="tick">‚úì</span><span>${x}</span></li>
            `).join("")}
          </ul>
        `;

        card.addEventListener("click", () => {
          haptic("light");
          selectedPlanId = plan.id;
          // if crypto chosen but basic -> force card
          if (selectedPlanId === "basic" && payMethodSub === "crypto") payMethodSub = "card";
          updatePayTabs();
          renderPlans();
          updateButtons();
        });

        plansEl.appendChild(card);
      }
    }

    const tokenPacksEl = document.getElementById("tokenPacks");
    function renderTokenPacks() {
      tokenPacksEl.innerHTML = "";
      for (const pack of TOKEN_PACKS) {
        const item = document.createElement("div");
        item.className = "tokenItem";
        item.style.cursor = "pointer";
        item.style.borderColor = (pack.id === selectedTokenPackId) ? "rgba(45,212,191,.55)" : "var(--stroke)";
        item.style.boxShadow = (pack.id === selectedTokenPackId) ? "0 0 0 1px rgba(45,212,191,.25) inset" : "none";

        item.innerHTML = `
          <div>
            <strong>${pack.name[LANG] || pack.name.ru}</strong><br/>
            <span>${pack.note[LANG] || pack.note.ru}</span>
          </div>
          <div style="text-align:right">
            <strong>${money(pack.price_uah)}</strong><br/>
            <span>${pack.id === selectedTokenPackId ? (t.chosen) : (t.choose)}</span>
          </div>
        `;

        item.addEventListener("click", () => {
          selectedTokenPackId = pack.id;
          renderTokenPacks();
          updateButtons();
        
  try { document.getElementById("payBtn")?.classList.add("vf-glow"); } catch(e) {}
});

        tokenPacksEl.appendChild(item);
      }
    }

    // top tabs
    const tabs = document.querySelectorAll(".tab");
    const screenSub = document.getElementById("screen-sub");
    const screenTok = document.getElementById("screen-tok");

    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        tabs.forEach(x => x.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        if (tab === "sub") {
          selectedMode = "subscription";
          screenSub.classList.add("active");
          screenTok.classList.remove("active");
        } else {
          selectedMode = "tokens";
          screenTok.classList.add("active");
          screenSub.classList.remove("active");
        }
        updateButtons();
      });
    });

    // period tabs
    const periodTabsSub = document.getElementById("periodTabsSub");
    if (periodTabsSub) {
      const btns = periodTabsSub.querySelectorAll(".payTab");
      // set labels by language
      btns.forEach(b => {
        const p = b.dataset.period;
        if (p === "month") b.textContent = t.period_m;
        if (p === "quarter") b.textContent = t.period_q;
        if (p === "year") b.textContent = t.period_y;
      });
      periodTabsSub.addEventListener("click", (e) => {
        const b = e.target.closest(".payTab");
        if (!b) return;
        haptic("light");
        btns.forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        selectedPeriod = b.dataset.period || "month";
        renderPlans();
        updateButtons();
      });
    }

    // pay tabs

const payTabsSub = document.getElementById("payTabsSub");
const payTabsTok = document.getElementById("payTabsTok");
function setActive(container, method){
  container?.querySelectorAll(".payTab")
    .forEach(b => b.classList.toggle("active", b.dataset.method === method));
}

function updatePayTabs(){
  const starsBtn  = payTabsSub?.querySelector('[data-method="stars"]');
  const cryptoBtn = payTabsSub?.querySelector('[data-method="crypto"]');
  const cardBtn   = payTabsSub?.querySelector('[data-method="card"]');

  const tokCard   = payTabsTok?.querySelector('[data-method="card"]');
  const tokCrypto = payTabsTok?.querySelector('[data-method="crypto"]');

  const starsAllowed  = Boolean(tg && typeof tg.openInvoice === "function" && calcStars(selectedPlanId) > 0);
  const cryptoAllowed = (selectedPlanId === "pro" || selectedPlanId === "max");

  if (cardBtn)  cardBtn.textContent  = t.pay_card;

  if (starsBtn) {
    starsBtn.disabled = !starsAllowed;
    starsBtn.textContent = t.pay_stars;
  }

  if (cryptoBtn) {
    const planObj = PLANS.find(x => x.id === selectedPlanId);
  const priceUah = planObj ? calcPriceUah(planObj) : 0;
  const usd = calcUsdApprox(priceUah);
  cryptoBtn.textContent = t.pay_crypto + (cryptoAllowed ? ` (~$${usd})` : " (Pro/Max)");}

  if (tokCard)   tokCard.textContent = t.pay_card;
  if (tokCrypto) tokCrypto.textContent = t.pay_crypto + " (soon)";

  if (!starsAllowed && payMethodSub === "stars")  payMethodSub = "card";
  if (!cryptoAllowed && payMethodSub === "crypto") payMethodSub = "card";

  if (payTabsSub) setActive(payTabsSub, payMethodSub);
  if (payTabsTok) setActive(payTabsTok, payMethodTok);
}

payTabsSub?.addEventListener("click", (e) => {
  const b = e.target.closest(".payTab");
  if (!b || b.disabled) return;
  haptic("light");
  const method = b.dataset.method || "card";
  if (method === "crypto") {
    const cryptoAllowed = (selectedPlanId === "pro" || selectedPlanId === "max");
    if (!cryptoAllowed) { tgPopup(t.pay_hint_basic_crypto_off); return; }
  }
  payMethodSub = method;
  updatePayTabs();
  renderPlans();
  updateButtons();
});

payTabsTok?.addEventListener("click", (e) => {
  const b = e.target.closest(".payTab");
  if (!b || b.disabled) return;
  payMethodTok = b.dataset.method || "card";
  updatePayTabs();
  updateButtons();
});

const payHint = document.getElementById("payHint");
const payHintTok = document.getElementById("payHintTok");

function updateButtons(){
  updatePayTabs();
  if (payHintTok) payHintTok.textContent = "";

  const payBtn = document.getElementById("payBtn");
  const buyBtn = document.getElementById("buyTokensBtn");

  if (payBtn) {
    const plan = PLANS.find(x => x.id === selectedPlanId);
    const priceUah = calcPriceUah(plan);
    const stars = calcStars(selectedPlanId);

    const usd = calcUsdApprox(priceUah);

    payBtn.textContent = (payMethodSub === "stars")
      ? `${t.btn_pay} ${stars}‚≠ê`
      : (payMethodSub === "crypto")
        ? `${t.btn_pay} ~$${usd}`
        : `${t.btn_pay} ${money(priceUah)}`;}

  if (buyBtn) {
    const pack = TOKEN_PACKS.find(x => x.id === selectedTokenPackId);
    buyBtn.textContent = `${t.btn_buy} ${money(pack.price_uah)}`;
  }
}

    // HARD rebind buttons (no matter what old listeners exist)
    function hardRebind(id, handler){
      const old = document.getElementById(id);
      if (!old) return null;
      const fresh = old.cloneNode(true);
      old.parentNode.replaceChild(fresh, old);
      fresh.addEventListener("click", handler);
      return fresh;
    }

    hardRebind("payBtn", async () => {
      haptic("medium");
      const plan = PLANS.find(x => x.id === selectedPlanId);
      const priceUah = calcPriceUah(plan);
      const stars = calcStars(selectedPlanId);
      const bonus = calcBonusTokens(selectedPlanId);

      if (payMethodSub === "crypto") {
        if (selectedPlanId === "basic") {
          tgPopup(t.pay_hint_basic_crypto_off);
          return;
        }
        // send to bot (backend will implement later)
                
                /* VF_CRYPTO_OPEN_NOW_V1 */
                try{
                  const tg = window.Telegram && window.Telegram.WebApp;
                  const qs = new URLSearchParams(window.location.search || "");
                  const tg_id = qs.get("tg_id") || String(tgUserId || "");
                  if (!tg_id) { tgPopup("tg_id –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }
                  const url = `/payments/now/create?tg_id=${encodeURIComponent(tg_id)}&plan=${encodeURIComponent(selectedPlanId)}&period=${encodeURIComponent(selectedPeriod)}&v=${Date.now()}`;
                  if (tg && typeof tg.openLink === "function") tg.openLink(url);
                  else window.location.href = url;
                }catch(e){
                  window.location.href = "/payments/now/create?plan=" + encodeURIComponent(selectedPlanId) + "&period=" + encodeURIComponent(selectedPeriod) + "&v=" + Date.now();
                }

                return;
}

      if (payMethodSub === "stars") {
        if (!stars || stars <= 0) { tgPopup("Stars amount is not configured"); return; }
        await payByStars(
          selectedPlanId,
          stars,
          "Premium",
          `Premium (${selectedPlanId}, ${selectedPeriod}) ‚Ä¢ –±–æ–Ω—É—Å +${bonus} —Ç–æ–∫–µ–Ω–æ–≤`
        );
        return;
      }

      // card
      await payByMono(
        `sub:${selectedPlanId}:${selectedPeriod}`,
        Number(priceUah),
        "DiaryBot Premium",
        `${plan.name} ‚Ä¢ ${selectedPeriod} ‚Ä¢ –±–æ–Ω—É—Å +${bonus} —Ç–æ–∫–µ–Ω–æ–≤`
      );
    });

    hardRebind("buyTokensBtn", async () => {
      const pack = TOKEN_PACKS.find(x => x.id === selectedTokenPackId);
      if (payMethodTok === "crypto") {
        tgPopup("–ö—Ä–∏–ø—Ç–∞ –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ–±–∞–≤–∏–º –ø–æ–∑–∂–µ");
        return;
      }
      await payByMono(
        `tokens:${pack.id}`,
        Number(pack.price_uah),
        "DiaryBot Tokens",
        `–ü–∞–∫–µ—Ç: ${pack.name[LANG] || pack.name.ru}`
      );
    });

    // init
    renderPlans();
    // VF_SWIPE_SELECT_V2: auto-select plan by centered card while swiping
    (function(){
      const carousel = document.getElementById("plans");
      if (!carousel) return;

      let timer = null;

      function selectCentered(){
        const cards = Array.from(carousel.querySelectorAll(".card"));
        if (!cards.length) return;

        const r = carousel.getBoundingClientRect();
        const centerX = r.left + r.width / 2;

        let best = null;
        let bestDist = 1e18;

        for (const c of cards) {
          const cr = c.getBoundingClientRect();
          const cx = cr.left + cr.width / 2;
          const d = Math.abs(cx - centerX);
          if (d < bestDist) { bestDist = d; best = c; }
        }

        const planId = best?.dataset?.plan;
        if (planId && planId !== selectedPlanId) {
          selectedPlanId = planId;
          // if basic + crypto chosen -> fallback
          if (selectedPlanId === "basic" && payMethodSub === "crypto") payMethodSub = "card";
          renderPlans();
          updatePayTabs();
          updateButtons();
        }
      }

      carousel.addEventListener("scroll", () => {
        clearTimeout(timer);
        timer = setTimeout(selectCentered, 120);
      }, { passive: true });
    })();

    renderTokenPacks();
    updateButtons();
  </script>
</body>
</html>
