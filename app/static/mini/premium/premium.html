<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Premium</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #071018;
      --panel: rgba(255,255,255,.06);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --brand: #2dd4bf;
      --brand2: #ec4899;
      --brand3: #a855f7;

      --success: #22c55e;
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.16);

      --radius2: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 520px at 20% -10%, rgba(45,212,191,.28), transparent 55%),
        radial-gradient(900px 420px at 90% 10%, rgba(236,72,153,.18), transparent 55%),
        radial-gradient(900px 520px at 70% 110%, rgba(168,85,247,.16), transparent 55%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      padding: calc(14px + env(safe-area-inset-top)) 14px calc(18px + env(safe-area-inset-bottom));
    }

    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:10px;}
    .title{font-size:18px;font-weight:800;margin:0;line-height:1.2;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35;}

    .pill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius:999px;
      display:flex;align-items:center;gap:8px;
      color:var(--muted);font-size:12px;white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--brand);
      box-shadow: 0 0 0 4px rgba(45,212,191,.18);
    }

    .tabs{
      display:flex;gap:6px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:6px;
      margin: 14px 0 14px;
    }
    .tab{
      flex:1;border:0;background:transparent;
      color: var(--muted);
      padding:11px 10px;border-radius:999px;
      font-weight:800;font-size:14px;cursor:pointer;
    }
    .tab.active{
      background: rgba(45,212,191,.18);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(45,212,191,.30);
    }

    .screen{display:none}
    .screen.active{display:block}

    .carousel{
      display:flex;gap:12px;overflow:auto;padding-bottom:6px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .carousel::-webkit-scrollbar{display:none}

    .card{
      min-width: 86%;
      scroll-snap-align: start;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius2);
      padding:14px;
      position:relative;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card.selected{
      border-color: rgba(45,212,191,.70);
      box-shadow:
        0 12px 34px rgba(0,0,0,.32),
        0 0 0 1px rgba(45,212,191,.28) inset;
      background:
        radial-gradient(900px 280px at 20% 0%, rgba(45,212,191,.20), transparent 60%),
        radial-gradient(900px 280px at 90% 10%, rgba(236,72,153,.14), transparent 60%),
        rgba(255,255,255,.055);
    }

    .badge{
      position:absolute;top:12px;right:12px;
      background: rgba(236,72,153,.18);
      border:1px solid rgba(236,72,153,.30);
      color: var(--text);
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
    }

    .cardHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:12px;}
    .planName{font-size:22px;font-weight:950;margin:0;letter-spacing:.2px;}
    .planDesc{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35;}

    .check{
      width:28px;height:28px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      flex: 0 0 auto;
    }
    .card.selected .check{
      border-color: rgba(45,212,191,.75);
      background: rgba(45,212,191,.18);
    }

    .priceRow{display:flex;align-items:baseline;gap:8px;margin: 10px 0 12px;}
    .price{font-size:46px;font-weight:950;letter-spacing:-.8px;}
    .per{color:var(--muted);font-size:14px;font-weight:800;}
    .smallLine{color:var(--muted);font-size:13px;margin-top:-6px;line-height:1.35;}
    .smallLine strong{color:rgba(255,255,255,.90);font-weight:900}

    .gift{
      display:flex;align-items:center;gap:10px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--stroke);
      padding:12px;border-radius: 14px;
      margin: 14px 0 10px;
    }
    .giftIcon{
      width:32px;height:32px;border-radius:10px;
      display:grid;place-items:center;
      background: rgba(168,85,247,.16);
      border:1px solid rgba(168,85,247,.22);
    }
    .giftText{font-weight:900;}

    .list{margin:10px 0 0;padding:0;list-style:none;display:grid;gap:10px;}
    .li{display:flex;align-items:flex-start;gap:10px;color: rgba(255,255,255,.88);font-size:14px;line-height:1.35;}
    .tick{
      width:18px;height:18px;border-radius:6px;
      background: rgba(34,197,94,.15);
      border:1px solid rgba(34,197,94,.30);
      display:grid;place-items:center;
      color: var(--success);
      margin-top:1px;flex: 0 0 auto;
    }

    .footer{margin-top: 16px;border-top:1px solid rgba(255,255,255,.08);padding-top:14px;}
    .payMethod{color:var(--muted);font-size:13px;margin: 0 0 10px;}

    .btn{
      width:100%;
      border:0;cursor:pointer;
      border-radius: 16px;
      padding: 16px 14px;
      font-weight:950;font-size:16px;
      color: white;
      background: linear-gradient(90deg, var(--brand), var(--brand2), var(--brand3));
      box-shadow: 0 10px 24px rgba(45,212,191,.18);
    }
    .btn:active{ transform: translateY(1px); }

    /* pay method pills */
    .payTabs{
      display:flex;gap:8px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:6px;
      margin: 10px 0 12px;
    }
    .payTab{
      flex:1;border:0;background:transparent;
      color: var(--muted);
      padding:10px 10px;border-radius:999px;
      font-weight:900;font-size:13px;cursor:pointer;
    }
    .payTab.active{
      background: rgba(45,212,191,.18);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(45,212,191,.30);
    }
    .payTab[disabled]{
      opacity:.45;
      cursor:not-allowed;
    }

    /* Tokens screen */
    .tokenBox{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius2);
      padding:14px;
    }
    .tokenTitle{font-size:18px;font-weight:950;margin:0 0 6px;}
    .tokenGrid{display:grid;gap:10px;margin-top:12px;}
    .tokenItem{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.045);
      border-radius: 16px;
      padding:12px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .tokenItem strong{font-size:14px}
    .tokenItem span{color:var(--muted);font-size:13px}
  </style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1 class="title">–ü—Ä–µ–º–∏—É–º</h1>
      <p class="subtitle">–í—ã–±–µ—Ä–∏ –ø–æ–¥–ø–∏—Å–∫—É (–ë–µ–π—Å–∏–∫/–ü—Ä–æ/–ú–∞–∫—Å) –∏–ª–∏ —Ç–æ–∫–µ–Ω—ã –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –∑–∞–¥–∞—á.</p>
    </div>
    <div class="pill" id="userPill">
      <span class="dot"></span>
      <span id="userText">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
    </div>
  </div>

  <div class="tabs" role="tablist">
    <button class="tab active" data-tab="sub">–ü–æ–¥–ø–∏—Å–∫–∞</button>
    <button class="tab" data-tab="tok">–¢–æ–∫–µ–Ω—ã</button>
  </div>

  <section class="screen active" id="screen-sub">
    <div class="carousel" id="plans"></div>

    <div class="footer">
      <p class="payMethod" id="payHint">–û–ø–ª–∞—Ç–∞: –∫–∞—Ä—Ç–∞ (UAH) –∏–ª–∏ Stars (—Ç–æ–ª—å–∫–æ –ë–µ–π—Å–∏–∫).</p>

      <div class="payTabs" id="payTabsSub">
        <button class="payTab active" data-method="card">üí≥ –ö–∞—Ä—Ç–∞</button>
        <button class="payTab" data-method="stars">‚≠ê Stars</button>
        <button class="payTab" data-method="crypto" disabled>ü™ô –ö—Ä–∏–ø—Ç–∞ (—Å–∫–æ—Ä–æ)</button>
      </div>

      <button class="btn" id="payBtn">–û–ø–ª–∞—Ç–∏—Ç—å</button>
    </div>
  </section>

  <section class="screen" id="screen-tok">
    <div class="tokenBox">
      <h2 class="tokenTitle">–ü–∞–∫–µ—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤</h2>
      <div class="subtitle" style="margin:0;">–¢–æ–∫–µ–Ω—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∑–∞ —Ç—è–∂—ë–ª—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–≤–∏–¥–µ–æ/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/–¥–æ—Ä–æ–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã).</div>

      <div class="tokenGrid" id="tokenPacks"></div>

      <div class="footer">
        <p class="payMethod" id="payHintTok">–û–ø–ª–∞—Ç–∞: –∫–∞—Ä—Ç–∞ (UAH).</p>

        <div class="payTabs" id="payTabsTok">
          <button class="payTab active" data-method="card">üí≥ –ö–∞—Ä—Ç–∞</button>
          <button class="payTab" data-method="crypto" disabled>ü™ô –ö—Ä–∏–ø—Ç–∞ (—Å–∫–æ—Ä–æ)</button>
        </div>

        <button class="btn" id="buyTokensBtn">–ö—É–ø–∏—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
      </div>
    </div>
  </section>

  <script>
    const tg = window.Telegram?.WebApp || null;

    function tgPopup(msg){
      try { tg?.showPopup?.({ message: String(msg) }); } catch(e) {}
    }

    let tgUserId = null;
    if (tg) {
      try { tg.ready(); } catch(e) {}
      try { tg.expand(); } catch(e) {}

      const u = tg.initDataUnsafe?.user;
      if (u) {
        tgUserId = u.id || null;
        document.getElementById('userText').textContent =
          `${u.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}${u.username ? ' @' + u.username : ''}`;
      }
    }

    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞–ª—é—Ç/Stars ===
    const CURRENCY = "UAH";
    const BASIC_STARS = 100; // <-- –ø–æ—Å—Ç–∞–≤—å —Ç–æ—á–Ω–æ–µ —á–∏—Å–ª–æ ‚≠ê –¥–ª—è –ë–µ–π—Å–∏–∫–∞

    function money(n){ return `${n}‚Ç¥`; }

    /* ---------- Telegram Stars (WebApp) ---------- */
    async function payByStars(planId, starsAmount, title, description) {
      if (!tg || typeof tg.openInvoice !== "function") {
        tgPopup("openInvoice –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π WebApp –≤–Ω—É—Ç—Ä–∏ Telegram.");
        return false;
      }

      try {
        const payload = `stars:buy:webapp:${planId}:${Date.now()}`;

        const resp = await fetch("/api/stars/invoice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            stars: Number(starsAmount || 0),
            payload,
            title: title || "Premium",
            description: description || `Premium (${planId}) —á–µ—Ä–µ–∑ Telegram Stars`,
          }),
        });

        let out = null;
        try { out = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          tgPopup("Stars API error: " + (out?.detail || resp.status));
          return false;
        }

        const link = out?.invoice_link;
        if (!link) {
          tgPopup("invoice_link –Ω–µ –ø–æ–ª—É—á–µ–Ω");
          return false;
        }

        tg.openInvoice(link, (status) => {
          console.log("Stars invoice status:", status);
          tgPopup("–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: " + status);
        });

        return true;
      } catch (e) {
        tgPopup("Stars error: " + String(e));
        return false;
      }
    }
    /* ---------- /Telegram Stars (WebApp) ---------- */

    /* ---------- Monobank Card (WebApp) ---------- */
    async function payByMono(kind, amountUah, title, description) {
      if (!tg) {
        alert("DEV MODE: tg is missing");
        return false;
      }
      if (!tgUserId) {
        tgPopup("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å user id Telegram");
        return false;
      }

      try {
        const resp = await fetch("/api/mono/invoice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            tg_id: Number(tgUserId),
            kind: String(kind || "unknown"),
            amount_uah: Number(amountUah || 0),
            title: title || "DiaryBot Premium",
            description: description || "–û–ø–ª–∞—Ç–∞ Premium",
            // –º–æ–∂–Ω–æ –ø–æ—Ç–æ–º –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–≤–æ–π –¥–æ–º–µ–Ω/—Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—Ö–∞:
            // redirect_url: location.origin + "/static/mini/premium/premium.html"
          }),
        });

        let out = null;
        try { out = await resp.json(); } catch (e) {}

        if (!resp.ok) {
          tgPopup("Mono API error: " + (out?.detail || resp.status));
          return false;
        }

        const url = out?.invoice_url;
        if (!url) {
          tgPopup("invoice_url –Ω–µ –ø–æ–ª—É—á–µ–Ω");
          return false;
        }

        // –í—Å—Ç—Ä–æ–µ–Ω–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É –≤ Telegram
        if (typeof tg.openLink === "function") tg.openLink(url);
        else window.open(url, "_blank");

        return true;
      } catch (e) {
        tgPopup("Mono error: " + String(e));
        return false;
      }
    }
    /* ---------- /Monobank Card (WebApp) ---------- */

    // === –ø–ª–∞–Ω—ã ===
    const PLANS = [
      {
        id: "basic",
        tag: "‚≠ê –õ—É—á—à–∏–π —Å—Ç–∞—Ä—Ç",
        name: "–ë–µ–π—Å–∏–∫",
        desc: "–û–ø—Ç–∏–º–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –±—ã—Ç—å –≤ –ø–æ—Ç–æ–∫–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.",
        price_uah: 199,
        per: "–º–µ—Å—è—Ü",
        under_price: "–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã",
        gift: "üéÅ –±–æ–Ω—É—Å —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ø–æ–¥–∞—Ä–æ–∫",
        bullets: [
          "–î–æ—Å—Ç—É–ø –∫ –∫–ª—é—á–µ–≤—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞",
          "–õ–∏–º–∏—Ç—ã –≤—ã—à–µ, —á–µ–º —É Free",
          "Stars –¥–æ—Å—Ç—É–ø–Ω—ã (—Ç–æ–ª—å–∫–æ –ë–µ–π—Å–∏–∫)",
          "–ê–ø–≥—Ä–µ–π–¥ –Ω–∞ –ü—Ä–æ/–ú–∞–∫—Å –≤ 1 –∫–ª–∏–∫"
        ]
      },
      {
        id: "pro",
        tag: "üî• –î–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã",
        name: "–ü—Ä–æ",
        desc: "–ï—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –ø–æ–ª—å–∑—É–µ—à—å—Å—è –±–æ—Ç–æ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –∏ —Ö–æ—á–µ—à—å –±–æ–ª—å—à–µ.",
        price_uah: 499,
        per: "–º–µ—Å—è—Ü",
        under_price: "–ë–æ–ª—å—à–µ –ª–∏–º–∏—Ç–æ–≤ –∏ –º–µ–Ω—å—à–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π",
        gift: "üéÅ –±–æ–ª—å—à–µ –±–æ–Ω—É—Å–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤",
        bullets: [
          "–ü–æ–≤—ã—à–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è",
          "–ö–æ–º—Ñ–æ—Ä—Ç–Ω–µ–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã",
          "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º",
          "–õ—É—á—à–∏–π –±–∞–ª–∞–Ω—Å —Ü–µ–Ω–∞/–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏"
        ]
      },
      {
        id: "max",
        tag: "üöÄ –ú–∞–∫—Å–∏–º—É–º",
        name: "–ú–∞–∫—Å",
        desc: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã –∏ —Å–∞–º—ã–π –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º.",
        price_uah: 999,
        per: "–º–µ—Å—è—Ü",
        under_price: "–ú–∞–∫—Å–∏–º—É–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –∏ –ª–∏–º–∏—Ç–æ–≤",
        gift: "üéÅ –º–∞–∫—Å–∏–º—É–º –±–æ–Ω—É—Å–æ–≤",
        bullets: [
          "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã",
          "–°–∞–º—ã–π –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º",
          "–î–ª—è —Ç–µ—Ö, –∫—Ç–æ –¥–µ–ª–∞–µ—Ç –º–Ω–æ–≥–æ –∑–∞–¥–∞—á",
          "–ü–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –∂—ë—Å—Ç–∫—É—é –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É"
        ]
      },
    ];

    const TOKEN_PACKS = [
      { id: "t100", name: "100 —Ç–æ–∫–µ–Ω–æ–≤", price_uah: 199, note: "–ò–Ω–æ–≥–¥–∞, —Ç–æ—á–µ—á–Ω–æ" },
      { id: "t300", name: "300 —Ç–æ–∫–µ–Ω–æ–≤", price_uah: 499, note: "–û–ø—Ç–∏–º–∞–ª—å–Ω–æ –Ω–∞ –Ω–µ–¥–µ–ª—é" },
      { id: "t800", name: "800 —Ç–æ–∫–µ–Ω–æ–≤", price_uah: 1099, note: "–ê–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞" },
    ];

    let selectedMode = "subscription";
    let selectedPlanId = "basic";
    let selectedTokenPackId = "t300";

    // payment method state
    let payMethodSub = "card";   // card|stars|crypto
    let payMethodTok = "card";   // card|crypto

    const plansEl = document.getElementById("plans");
    function renderPlans() {
      plansEl.innerHTML = "";
      for (const p of PLANS) {
        const card = document.createElement("div");
        card.className = "card" + (p.id === selectedPlanId ? " selected" : "");
        card.dataset.plan = p.id;

        const starsLine = (p.id === "basic" && BASIC_STARS > 0)
          ? `<div class="smallLine">–∏–ª–∏ <strong>${BASIC_STARS}‚≠ê</strong> —á–µ—Ä–µ–∑ Telegram Stars</div>`
          : "";

        card.innerHTML = `
          ${p.tag ? `<div class="badge">${p.tag}</div>` : ""}
          <div class="cardHeader">
            <div>
              <h3 class="planName">${p.name}</h3>
              <p class="planDesc">${p.desc}</p>
            </div>
            <div class="check" aria-label="selected">
              ${p.id === selectedPlanId ? "‚úì" : ""}
            </div>
          </div>

          <div class="priceRow">
            <div class="price">${money(p.price_uah)}</div>
            <div class="per">/ ${p.per}</div>
          </div>

          <div class="smallLine"><strong>${p.under_price || ""}</strong></div>

          ${starsLine}

          <div class="gift">
            <div class="giftIcon">üéÅ</div>
            <div class="giftText">${p.gift}</div>
          </div>

          <ul class="list">
            ${p.bullets.map(x => `
              <li class="li">
                <span class="tick">‚úì</span>
                <span>${x}</span>
              </li>
            `).join("")}
          </ul>
        `;

        card.addEventListener("click", () => {
          selectedPlanId = p.id;
          // –µ—Å–ª–∏ —É—à–ª–∏ —Å basic ‚Äî Stars –∞–≤—Ç–æ–º–∞—Ç–æ–º –≤—ã–∫–ª—é—á–∞–µ–º
          if (selectedPlanId !== "basic" && payMethodSub === "stars") payMethodSub = "card";
          renderPlans();
          updatePayTabs();
          updateButtons();
        });

        plansEl.appendChild(card);
      }
    }

    const tokenPacksEl = document.getElementById("tokenPacks");
    function renderTokenPacks() {
      tokenPacksEl.innerHTML = "";
      for (const t of TOKEN_PACKS) {
        const item = document.createElement("div");
        item.className = "tokenItem";
        item.style.cursor = "pointer";
        item.style.borderColor = (t.id === selectedTokenPackId) ? "rgba(45,212,191,.55)" : "var(--stroke)";
        item.style.boxShadow = (t.id === selectedTokenPackId) ? "0 0 0 1px rgba(45,212,191,.25) inset" : "none";

        item.innerHTML = `
          <div>
            <strong>${t.name}</strong><br/>
            <span>${t.note}</span>
          </div>
          <div style="text-align:right">
            <strong>${money(t.price_uah)}</strong><br/>
            <span>${t.id === selectedTokenPackId ? "–≤—ã–±—Ä–∞–Ω–æ" : "–≤—ã–±—Ä–∞—Ç—å"}</span>
          </div>
        `;

        item.addEventListener("click", () => {
          selectedTokenPackId = t.id;
          renderTokenPacks();
          updateButtons();
        });

        tokenPacksEl.appendChild(item);
      }
    }

    // tabs
    const tabs = document.querySelectorAll(".tab");
    const screenSub = document.getElementById("screen-sub");
    const screenTok = document.getElementById("screen-tok");

    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        tabs.forEach(x => x.classList.remove("active"));
        btn.classList.add("active");

        const tab = btn.dataset.tab;
        if (tab === "sub") {
          selectedMode = "subscription";
          screenSub.classList.add("active");
          screenTok.classList.remove("active");
        } else {
          selectedMode = "tokens";
          screenTok.classList.add("active");
          screenSub.classList.remove("active");
        }
        updateButtons();
      });
    });

    // pay method tabs
    const payTabsSub = document.getElementById("payTabsSub");
    const payTabsTok = document.getElementById("payTabsTok");

    function setActivePayTab(container, method){
      const btns = container.querySelectorAll(".payTab");
      btns.forEach(b => b.classList.toggle("active", b.dataset.method === method));
    }

    function updatePayTabs(){
      // subscription: stars only if basic + BASIC_STARS > 0
      const starsBtn = payTabsSub.querySelector('[data-method="stars"]');
      const starsAllowed = (selectedPlanId === "basic" && Number(BASIC_STARS) > 0 && tg && typeof tg.openInvoice === "function");
      starsBtn.disabled = !starsAllowed;

      if (!starsAllowed && payMethodSub === "stars") payMethodSub = "card";

      setActivePayTab(payTabsSub, payMethodSub);
      setActivePayTab(payTabsTok, payMethodTok);
    }

    payTabsSub.addEventListener("click", (e) => {
      const b = e.target.closest(".payTab");
      if (!b || b.disabled) return;
      payMethodSub = b.dataset.method;
      updatePayTabs();
      updateButtons();
    });

    payTabsTok.addEventListener("click", (e) => {
      const b = e.target.closest(".payTab");
      if (!b || b.disabled) return;
      payMethodTok = b.dataset.method;
      updatePayTabs();
      updateButtons();
    });

    const payBtn = document.getElementById("payBtn");
    const buyTokensBtn = document.getElementById("buyTokensBtn");
    const payHint = document.getElementById("payHint");
    const payHintTok = document.getElementById("payHintTok");

    function updateButtons() {
      updatePayTabs();

      if (selectedMode === "subscription") {
        const plan = PLANS.find(p => p.id === selectedPlanId);
        payBtn.textContent = `–û–ø–ª–∞—Ç–∏—Ç—å ‚Äî ${money(plan.price_uah)}`;

        const starsAllowed = (selectedPlanId === "basic" && Number(BASIC_STARS) > 0);
        if (selectedPlanId === "basic" && starsAllowed) {
          payHint.textContent = `–û–ø–ª–∞—Ç–∞: –∫–∞—Ä—Ç–∞ (${CURRENCY}) –∏–ª–∏ Telegram Stars (${BASIC_STARS}‚≠ê).`;
        } else {
          payHint.textContent = `–û–ø–ª–∞—Ç–∞: –∫–∞—Ä—Ç–∞ (${CURRENCY}).`;
        }
      } else {
        const pack = TOKEN_PACKS.find(t => t.id === selectedTokenPackId);
        buyTokensBtn.textContent = `–ö—É–ø–∏—Ç—å ‚Äî ${money(pack.price_uah)}`;
        payHintTok.textContent = `–û–ø–ª–∞—Ç–∞: –∫–∞—Ä—Ç–∞ (${CURRENCY}).`;
      }
    }

    // --- pay actions ---
    payBtn.addEventListener("click", async () => {
      const plan = PLANS.find(p => p.id === selectedPlanId);

      if (payMethodSub === "stars") {
        if (selectedPlanId !== "basic") { tgPopup("Stars –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ë–µ–π—Å–∏–∫–∞"); return; }
        if (!(Number(BASIC_STARS) > 0)) { tgPopup("Stars –¥–ª—è –ë–µ–π—Å–∏–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"); return; }
        await payByStars("basic", Number(BASIC_STARS), "Premium", "Premium (–ë–µ–π—Å–∏–∫) —á–µ—Ä–µ–∑ Telegram Stars");
        return;
      }

      if (payMethodSub === "crypto") {
        tgPopup("–ö—Ä–∏–ø—Ç–∞ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞");
        return;
      }

      // card
      await payByMono(
        `sub:${selectedPlanId}`,
        Number(plan.price_uah),
        "DiaryBot Premium",
        `–ü–æ–¥–ø–∏—Å–∫–∞: ${plan.name} / ${plan.per}`
      );
    });

    buyTokensBtn.addEventListener("click", async () => {
      const pack = TOKEN_PACKS.find(t => t.id === selectedTokenPackId);

      if (payMethodTok === "crypto") {
        tgPopup("–ö—Ä–∏–ø—Ç–∞ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞");
        return;
      }

      await payByMono(
        `tokens:${pack.id}`,
        Number(pack.price_uah),
        "DiaryBot Tokens",
        `–ü–∞–∫–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤: ${pack.name}`
      );
    });

    renderPlans();
    renderTokenPacks();
    updateButtons();
  </script>
</body>
</html>
