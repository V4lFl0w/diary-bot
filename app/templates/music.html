<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DiaryBot ‚Ä¢ Music</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; background:#0b0f19; color:#e8eefc; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 24px 18px 40px; }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); border-radius: 16px; padding: 16px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
    h1 { font-size: 22px; margin: 0 0 10px; }
    p { margin: 0 0 14px; opacity: .9; line-height: 1.35; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; }
    .btn { display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 14px 14px; border-radius: 14px; text-decoration:none; color:inherit;
      background: rgba(255,255,255,.07); border: 1px solid rgba(255,255,255,.12);
    }
    .btn:hover { background: rgba(255,255,255,.10); }
    .tag { font-size: 12px; opacity: .75; }
    .footer { margin-top: 14px; font-size: 12px; opacity: .7; }
    code { background: rgba(255,255,255,.08); padding: 2px 6px; border-radius: 8px; }
  </style>
</head>
<body>

<!-- UX: Sections (Collections / Playlist / Popular) -->
<div class="ux-sections" style="margin:10px 0 12px;">
  <div class="ux-tabs" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
    <button type="button" class="chip chip--active" data-ux-tab="collections">–ü–æ–¥–±–æ—Ä–∫–∏</button>
    <button type="button" class="chip" data-ux-tab="playlist">–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç</button>
    <button type="button" class="chip" data-ux-tab="popular">–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</button>
  </div>

  <div class="ux-presets" data-ux-panel="collections" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
    <button type="button" class="chip" data-ux-preset="focus">Focus</button>
    <button type="button" class="chip" data-ux-preset="sleep">Sleep</button>
    <button type="button" class="chip" data-ux-preset="relax">Relax</button>
    <button type="button" class="chip" data-ux-preset="energise">Energise</button>
    <button type="button" class="chip" data-ux-preset="feelgood">Feel good</button>
    <button type="button" class="chip" data-ux-preset="workout">Workout</button>
  </div>
</div>

<div class="ux-panel" data-ux-panel="collections"></div>
<div class="ux-panel" data-ux-panel="playlist" style="display:none;"></div>
<div class="ux-panel" data-ux-panel="popular" style="display:none;"></div>
</div>

  <div class="wrap">
    <div class="card">
      <h1>üéµ Music</h1>
      <p>–§—É–Ω–¥–∞–º–µ–Ω—Ç –≥–æ—Ç–æ–≤. –í –±–æ—Ç–µ: <code>/music</code> ‚Üí –ø–æ–∏—Å–∫ ‚Üí –ø—Ä–µ–≤—å—é ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.</p>

      <div class="grid">
        <a class="btn" href="/pay"><span>üíé –ü—Ä–µ–º–∏—É–º</span><span class="tag">–æ–ø–ª–∞—Ç–∞</span></a>
        <a class="btn" href="https://t.me/"><span>ü§ñ –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</span><span class="tag">Telegram</span></a>
      </div>

      <div class="footer">
        –î–∞–ª—å—à–µ —Ä–∞—Å—à–∏—Ä–∏–º: –ø–∞–≥–∏–Ω–∞—Ü–∏—è, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, ‚Äú–º–æ—ë/–∏–∑ –ø–æ–∏—Å–∫–∞‚Äù, –≤–µ–±-–ø–ª–µ–π–ª–∏—Å—Ç, —É–¥–∞–ª–µ–Ω–∏–µ.
      </div>
    </div>
  </div>

<!-- TG DEBUG UI (injected) -->
<style>
  .tgdbg-btn{position:fixed;right:14px;bottom:14px;z-index:99999;background:#1f2937;color:#fff;border:none;border-radius:14px;padding:10px 12px;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,.25);opacity:.92}
  .tgdbg-btn:active{transform:translateY(1px)}
  .tgdbg-panel{position:fixed;left:10px;right:10px;bottom:64px;z-index:99999;background:rgba(17,24,39,.98);color:#e5e7eb;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px;display:none}
  .tgdbg-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .tgdbg-inp{flex:1;min-width:180px;background:rgba(255,255,255,.06);color:#fff;border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none}
  .tgdbg-a{background:#2563eb;color:#fff;border:none;border-radius:12px;padding:10px 12px;font-weight:700}
  .tgdbg-b{background:#059669;color:#fff;border:none;border-radius:12px;padding:10px 12px;font-weight:700}
  .tgdbg-c{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px 12px;font-weight:700}
  .tgdbg-pre{white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.25);border-radius:12px;padding:10px;max-height:40vh;overflow:auto;font-size:12px;line-height:1.35}
</style>

<button id="tgdbgBtn" class="tgdbg-btn" type="button">TG DEBUG</button>
<div id="tgdbgPanel" class="tgdbg-panel">
  <div class="tgdbg-row">
    <input id="tgdbgQ" class="tgdbg-inp" placeholder="–ó–∞–ø—Ä–æ—Å –¥–ª—è TG-search (–Ω–∞–ø—Ä–∏–º–µ—Ä: Kizaru - XXL Freestyle)" />
  </div>
  <div class="tgdbg-row">
    <button id="tgdbgTest" class="tgdbg-a" type="button">TEST</button>
    <button id="tgdbgSend" class="tgdbg-b" type="button">TEST+SEND</button>
    <button id="tgdbgClose" class="tgdbg-c" type="button">CLOSE</button>
  </div>
  <div class="tgdbg-row" style="opacity:.85;font-size:12px">
    <span>TEST = —Ç–æ–ª—å–∫–æ –ø–æ–∏—Å–∫; TEST+SEND = –ø–æ–∏—Å–∫ + copyMessage –≤ —Ç–≤–æ–π —á–∞—Ç</span>
  </div>
  <pre id="tgdbgOut" class="tgdbg-pre">{}</pre>
</div>

<script>
(function(){
  function getTgId(){
    try{
      const u = new URL(window.location.href);
      const v = u.searchParams.get("tg_id");
      if(v) return v;
    }catch(e){}
    // fallback: –µ—Å–ª–∏ –µ—Å—Ç—å Telegram WebApp
    try{
      const id = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
      if(id) return String(id);
    }catch(e){}
    return "";
  }

  async function callTgTest(send){
    const q = (document.getElementById("tgdbgQ").value || "").trim();
    const tgId = getTgId();
    const out = document.getElementById("tgdbgOut");
    if(!q){ out.textContent = "ERR: empty query"; return; }
    if(!tgId){ out.textContent = "ERR: tg_id missing in URL and Telegram initData"; return; }

    const url = "/webapp/music/api/tg_test?q=" + encodeURIComponent(q) + "&tg_id=" + encodeURIComponent(tgId) + "&send=" + (send? "1":"0");
    out.textContent = "Loading...\n" + url;

    try{
      const r = await fetch(url, {method:"GET"});
      const data = await r.json().catch(()=>({raw:"non-json"}));
      out.textContent = JSON.stringify({status:r.status, data}, null, 2);
    }catch(e){
      out.textContent = "FETCH_ERR: " + (e && e.message ? e.message : String(e));
    }
  }

  const btn = document.getElementById("tgdbgBtn");
  const panel = document.getElementById("tgdbgPanel");
  const close = document.getElementById("tgdbgClose");
  const test = document.getElementById("tgdbgTest");
  const send = document.getElementById("tgdbgSend");

  btn.addEventListener("click", ()=>{ panel.style.display = (panel.style.display==="block" ? "none" : "block"); });
  close.addEventListener("click", ()=>{ panel.style.display = "none"; });
  test.addEventListener("click", ()=>callTgTest(false));
  send.addEventListener("click", ()=>callTgTest(true));
})();
</script>
<!-- /TG DEBUG UI -->


<!-- TG DEBUG button (temporary) -->
<button id="tgDebugBtn"
  style="position:fixed;right:14px;bottom:14px;z-index:99999;padding:10px 12px;border-radius:12px;border:0;background:#2b6cff;color:#fff;font-weight:700">
  TG DEBUG
</button>
<script>
(function(){
  const btn = document.getElementById("tgDebugBtn");
  if(!btn) return;

  function getTgId(){
    try { return (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user && Telegram.WebApp.initDataUnsafe.user.id) || null; }
    catch(e){ return null; }
  }

  function getQuery(){
    // –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π input –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const inp = document.querySelector('input[type="text"], input:not([type])');
    return (inp && inp.value ? inp.value : "").trim();
  }

  btn.addEventListener("click", async () => {
    const tg_id = getTgId();
    const q = getQuery();
    if(!tg_id){ alert("tg_id missing (open inside Telegram)"); return; }
    if(!q || q.length < 2){ alert("–í–≤–µ–¥–∏ –∑–∞–ø—Ä–æ—Å –≤ –ø–æ–ª–µ (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)"); return; }

    btn.disabled = true; btn.innerText = "DEBUG...";
    try{
      const url = `/webapp/music/api/tg_debug?tg_id=${encodeURIComponent(tg_id)}&q=${encodeURIComponent(q)}`;
      const r = await fetch(url);
      const data = await r.json();
      console.log("TG_DEBUG", data);
      alert("TG_DEBUG –≥–æ—Ç–æ–≤. –°–º–æ—Ç—Ä–∏ console/log (–∏–ª–∏ –ø—Ä–∏—à–ª–∏ –º–Ω–µ JSON).");
    }catch(e){
      console.error(e);
      alert("TG_DEBUG error: " + (e && e.message ? e.message : e));
    }finally{
      btn.disabled = false; btn.innerText = "TG DEBUG";
    }
  });
})();
</script>


<!-- TG PIPELINE button (temporary) -->
<button id="tgPipelineBtn"
  style="position:fixed;right:14px;bottom:64px;z-index:99999;padding:10px 12px;border-radius:12px;border:0;background:#16a34a;color:#fff;font-weight:800">
  TG PIPELINE
</button>
<script>
(function(){
  const btn = document.getElementById("tgPipelineBtn");
  if(!btn) return;

  function getTgId(){
    try { return (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user && Telegram.WebApp.initDataUnsafe.user.id) || null; }
    catch(e){ return null; }
  }

  function getQuery(){
    const inp = document.querySelector('input[type="text"], input:not([type])');
    return (inp && inp.value ? inp.value : "").trim();
  }

  btn.addEventListener("click", async () => {
    const tg_id = getTgId();
    const q = getQuery();
    if(!tg_id){ alert("tg_id missing (open inside Telegram)"); return; }
    if(!q || q.length < 2){ alert("–í–≤–µ–¥–∏ –∑–∞–ø—Ä–æ—Å –≤ –ø–æ–ª–µ (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)"); return; }

    btn.disabled = true; btn.innerText = "RUN...";
    try{
      const url = `/webapp/music/api/tg_pipeline?tg_id=${encodeURIComponent(tg_id)}&q=${encodeURIComponent(q)}`;
      const r = await fetch(url, { method: "POST" });
      const data = await r.json();
      console.log("TG_PIPELINE", data);

      if(data && data.sent){
        alert("‚úÖ –û—Ç–ø—Ä–∞–≤–∏–ª —Ç—Ä–µ–∫ –≤ Telegram (—Å–º. —á–∞—Ç). –õ–æ–≥–∏ –≤ console: TG_PIPELINE");
      } else {
        alert("‚ö†Ô∏è –ù–µ –æ—Ç–ø—Ä–∞–≤–∏–ª. –°–º–æ—Ç—Ä–∏ console: TG_PIPELINE (debug + errors)");
      }
    }catch(e){
      console.error(e);
      alert("TG_PIPELINE error: " + (e && e.message ? e.message : e));
    }finally{
      btn.disabled = false; btn.innerText = "TG PIPELINE";
    }
  });
})();
</script>


<!-- ===== TG DEBUG BUTTON (dev) ===== -->
<div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
  <button id="tgDebugBtn" type="button"
    style="padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14);
           background:rgba(255,255,255,.06); color:#fff; font-weight:600;">
    üß™ TG Debug
  </button>
  <span id="tgDebugHint" style="opacity:.7; font-size:12px;">–∂–º—ë—Ç /tg_pipeline –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç raw JSON</span>
</div>
<pre id="tgDebugOut"
  style="display:none; margin-top:10px; padding:10px; border-radius:12px;
         background:rgba(0,0,0,.35); color:#d7f3ff; overflow:auto; max-height:280px; white-space:pre-wrap;"></pre>
<!-- ===== /TG DEBUG BUTTON ===== -->


<script>
(function(){
  function qs(name){
    return new URLSearchParams(window.location.search).get(name);
  }
  function getTgId(){
    const v = qs("tg_id");
    if (!v) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function getQuery(){
    // –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∏–Ω–ø—É—Ç (fallback –Ω–∞ –ø–µ—Ä–≤—ã–π input[type=text])
    const el = document.querySelector('input[name="q"], input#q, input[type="text"]');
    return (el && el.value ? el.value.trim() : "");
  }
  function setOut(obj){
    const pre = document.getElementById("tgDebugOut");
    if (!pre) return;
    pre.style.display = "block";
    try {
      pre.textContent = JSON.stringify(obj, null, 2);
    } catch(e){
      pre.textContent = String(obj);
    }
  }

  async function runTgPipeline(){
    const tg_id = getTgId();
    const q = getQuery();
    if (!tg_id){
      setOut({ok:false, error:"tg_id missing in URL. Open mini app inside Telegram."});
      return;
    }
    if (!q || q.length < 2){
      setOut({ok:false, error:"–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞) –∏ —Å–Ω–æ–≤–∞ –Ω–∞–∂–º–∏—Ç–µ üß™ TG Debug"});
      return;
    }

    setOut({ok:true, stage:"calling /tg_pipeline", tg_id, q});

    const url = "/webapp/music/api/tg_pipeline?q=" + encodeURIComponent(q) + "&tg_id=" + encodeURIComponent(String(tg_id));
    let resp, data;
    try{
      resp = await fetch(url, {method:"POST"});
      const txt = await resp.text();
      try { data = JSON.parse(txt); } catch(e){ data = {raw: txt}; }
    } catch(e){
      setOut({ok:false, stage:"fetch_failed", error:String(e)});
      return;
    }

    setOut({http_status: resp.status, ...data});
  }

  const btn = document.getElementById("tgDebugBtn");
  if (btn){
    btn.addEventListener("click", function(){
      runTgPipeline();
    });
  }
})();
</script>



<script>
(function () {
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function findButtonByText(txt) {
    const btns = $$("button");
    return btns.find(b => (b.textContent || "").trim() === txt) || null;
  }

  const input =
    $("#q") ||
    document.querySelector('input[type="search"]') ||
    document.querySelector('input[type="text"]');

  const btnFind =
    $("#btnGo") ||
    $("#btnFind") ||
    findButtonByText("–ù–∞–π—Ç–∏");

  function clickFind() {
    if (btnFind) btnFind.click();
  }

  // Tabs
  const tabs = $$('[data-ux-tab]');
  const presetRow = $('.ux-presets');

  function setActiveTab(name) {
    tabs.forEach(t => t.classList.toggle('chip--active', t.getAttribute('data-ux-tab') === name));

    // Presets visible in collections + popular, hidden in playlist
    if (presetRow) presetRow.style.display = (name === "playlist") ? "none" : "";

    // Playlist mode: trigger existing "–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç" loader if present
    if (name === "playlist") {
      const btnMy = $("#btnMy") || findButtonByText("–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç") || $('[data-action="my-playlist"]');
      if (btnMy) btnMy.click();
    }
  }

  tabs.forEach(t => t.addEventListener("click", () => setActiveTab(t.getAttribute("data-ux-tab"))));

  // Presets => smart queries
  const presetMap = {
    focus: "focus music mix",
    sleep: "sleep music calm",
    relax: "relax chill mix",
    energise: "energise upbeat mix",
    feelgood: "feel good vibes mix",
    workout: "workout music mix"
  };

  $$('.ux-presets [data-ux-preset]').forEach(btn => {
    btn.addEventListener("click", () => {
      const key = btn.getAttribute("data-ux-preset");
      const q = presetMap[key] || key;
      if (input) input.value = q;
      setActiveTab("collections");
      clickFind();
    });
  });

  // Default tab
  setActiveTab("collections");
})();
</script>

</body>
</html>
